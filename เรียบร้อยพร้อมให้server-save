<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CYBER RPG v7.3 (Double KO Rematch x2)</title>
    
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;600&family=Orbitron:wght@700;900&display=swap');

        /* --- Global Variables --- */
        :root {
            --neon-orange: #ff9d00;
            --neon-blue: #00eaff;
            --neon-red: #ff2a2a;
            --bg-dark: #050505;
            --bg-white: #f8f9fa;
            --card-width: 54px;
            --card-height: 76px;
            --gap: 6px;
            --total-width: calc((var(--card-width) * 5) + (var(--gap) * 4));
        }

        /* --- Reset & Layout --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body {
            margin: 0; padding: 0;
            background-color: #000;
            font-family: 'Kanit', sans-serif;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        .app-container {
            width: 100%; height: 100%; max-width: 480px;
            background-color: var(--bg-dark);
            position: relative; display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); overflow: hidden;
        }

        /* --- Screens --- */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background-size: cover; background-position: center; }
        .screen.active { display: flex; z-index: 999; }
        .screen-white { background-color: var(--bg-white) !important; color: #333; padding: 20px; overflow-y: auto; background-image: none !important; }
        #screen-login { background-image: url('https://github.com/user-attachments/assets/c9b596d6-88ee-4ca0-bf0a-a80b17ab31f0'); }
        #screen-lobby { background-image: url('https://github.com/user-attachments/assets/70b3047d-bbea-42b8-a8bd-96fe08c69f03'); }

        /* --- UI Components --- */
        .white-header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: 5px; color: #333; }
        .close-btn { font-size: 1.5rem; color: #aaa; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background:rgba(255,255,255,0.1); backdrop-filter:blur(5px); }
        .btn { background: linear-gradient(180deg, var(--neon-orange), #d35400); border: none; border-radius: 8px; color: #fff; font-weight: 600; cursor: pointer; padding: 10px; width:100%; font-family: 'Kanit'; }
        
        .btn-world-id {
            background: #ffffff; color: #000000; font-family: 'Orbitron'; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 0 20px rgba(255,255,255,0.4); transition: 0.2s;
        }
        .btn-world-id:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(255,255,255,0.2); }

        /* --- Lobby Elements --- */
        .top-bar { height: 80px; background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent); display: flex; align-items: center; padding: 0 15px; gap: 10px; flex-shrink: 0; color: white; text-shadow: 1px 1px 2px black; justify-content: space-between; }
        .avatar { width: 50px; height: 50px; border: 2px solid var(--neon-orange); border-radius: 50%; background: #333; overflow: hidden; flex-shrink: 0; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .lobby-content { flex: 1; overflow-y: auto; width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 20px; }
        .bottom-nav { height: 70px; background: var(--neon-orange); backdrop-filter: blur(10px); border: 3px solid var(--neon-blue); box-shadow: 0 0 20px rgba(255, 157, 0, 0.4); margin: 0 20px 30px 20px; border-radius: 35px; display: flex; justify-content: center; align-items: center; position: relative; z-index: 100; flex-shrink: 0; animation: pulse 2s infinite; cursor: pointer; }
        .nav-item { text-align: center; color: #000; font-size: 1.8rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; font-family: 'Orbitron'; width: 100%; text-shadow: 0 0 2px rgba(255,255,255,0.5); }

        .ad-banner { width: 100%; max-width: 380px; height: 100px; background: #222; margin: 10px auto; border-radius: 8px; border: 1px solid #444; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; flex-shrink: 0; }
        .ad-banner img { width: 100%; height: 100%; object-fit: cover; }
        .ad-tag { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.5); color: white; font-size: 0.6rem; padding: 2px 5px; }

        .video-box { width: 100%; max-width: 380px; height: 100px; margin: 0 auto 20px auto; border: 2px solid var(--neon-blue); box-shadow: 0 0 15px rgba(0, 234, 255, 0.4); background: #000; position: relative; flex-shrink: 0; }
        .video-label { position: absolute; top: 0; left: 0; background: var(--neon-blue); color: #000; font-family: 'Orbitron'; font-size: 0.5rem; font-weight: bold; padding: 2px 6px; z-index: 10; }
        
        .marquee-container { background: rgba(0,0,0,0.6); border: 1px solid var(--neon-blue); border-radius: 4px; height: 30px; display: flex; align-items: center; overflow: hidden; white-space: nowrap; position: relative; margin: 10px 15px; flex-shrink: 0; }
        .marquee-text { display: inline-block; padding-left: 100%; animation: scroll-left 15s linear infinite; color: var(--neon-blue); font-size: 0.8rem; font-family: 'Kanit'; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* --- Monster Cards --- */
        .monster-card { border-radius: 12px; margin-bottom: 10px; padding: 12px; display: flex; align-items: center; justify-content: space-between; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.1s; }
        .monster-card:active { transform: scale(0.98); }
        .rank-common { background: linear-gradient(135deg, #2c3e50, #4ca1af); }
        .rank-miniboss { background: linear-gradient(135deg, #1e3c72, #2a5298); border: 1px solid var(--neon-blue); }
        .rank-boss { background: linear-gradient(135deg, #8E0E00, #1F1C18); border: 2px solid #ffd700;} 
        .rank-legendary { background: linear-gradient(135deg, #FFD700, #FF8C00);  border: 2px solid white;  box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);  animation: goldPulse 2s infinite; }
        @keyframes goldPulse { 0% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 1); border-color: #fff; } 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); } }
        .m-avatar { width: 50px; height: 50px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); object-fit: cover; margin-right: 15px; }
        .m-info h3 { margin: 0; font-family: 'Orbitron'; font-size: 1rem; }
        .hp-badge { background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-family: 'Orbitron'; border: 1px solid rgba(255,255,255,0.2); min-width: 60px; text-align: center; }

        /* --- Battle System --- */
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        .shaking { animation: shake 0.5s; }
        .battle-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 10px; }
        .game-column { width: var(--total-width); display: flex; flex-direction: column; gap: 6px; }
        .boss-banner { width: 100%; height: 80px; border: 1px solid white; border-radius: 8px; overflow: hidden; background: #000; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .boss-banner img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .boss-banner.hit { border-color: red; animation: shake 0.2s; }
        
        .hp-wrapper { position: relative; width: 100%; margin: 2px 0; }
        .hp-container { width: 100%; height: 20px; background: #222; border: 1px solid white; border-radius: 4px; overflow: hidden; position: relative; }
        .hp-fill { height: 100%; width: 100%; transition: width 0.2s; }
        .hp-enemy { background: linear-gradient(90deg, #ff3333, #aa0000); }
        .hp-player { background: linear-gradient(90deg, #00eaff, #0066cc); }
        .hp-text { position: absolute; width: 100%; text-align: center; top: 0; font-size: 12px; line-height: 20px; color: #fff; font-weight: 900; text-shadow: 1px 1px 2px black; font-family: 'Orbitron'; letter-spacing: 1px; }
        
        .dmg-float { position: absolute; color: #fff; font-weight: 900; font-size: 2.5rem; text-shadow: 2px 2px 0 #ff0000; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); opacity: 0; transition: 0.3s; z-index: 50; font-family: 'Orbitron'; pointer-events: none; }
        .dmg-float.show { opacity: 1; transform: translate(-50%, -100%) scale(1); }
        
        .card-row { display: flex; gap: var(--gap); justify-content: center; width: 100%; height: 80px; margin-top: 4px; }
        .card-perspective { width: var(--card-width); height: var(--card-height); perspective: 1000px; flex-shrink: 0; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 6px; }
        .card-perspective.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-family: 'Orbitron'; font-size: 1.6rem; border: 1px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .card-front { background-color: #1a1a1a; background-image: url('https://images.unsplash.com/photo-1615818386470-3430ee8b3079?q=80&w=200'); background-size: cover; background-position: center; }
        .card-back { background: linear-gradient(135deg, #eee, #ccc); color: #000; transform: rotateY(180deg); font-weight: 900; }
        .card-perspective.flipped .card-back.enemy-revealed { background: linear-gradient(135deg, var(--neon-red), #990000); color: white; border: 1px solid white; box-shadow: 0 0 10px var(--neon-red); }
        
        .clash-zone { width: var(--total-width); height: 90px; display: flex; gap: var(--gap); justify-content: center; align-items: center; border-top: 1px solid rgba(255,255,255,0.2); border-bottom: 1px solid rgba(255,255,255,0.2); }
        .clash-slot { width: var(--card-width); height: var(--card-height); border: 1px solid rgba(255,255,255,0.4); border-radius: 6px; display: flex; align-items: center; justify-content: center; background: transparent; position: relative; flex-shrink: 0; }
        .clash-slot.active { border: 2px solid #fff; background: rgba(0, 234, 255, 0.15); box-shadow: 0 0 15px rgba(0, 234, 255, 0.3); }
        .clash-slot div { width: 100%; height: 100%; background:var(--neon-blue); color: #000; border-radius: 4px; border: 1px solid white; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 1.6rem; font-weight: 900; }
        
        .my-card { width: var(--card-width); height: var(--card-height); flex-shrink: 0; border: 1px solid white; color: var(--neon-orange); background: #111; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 1.6rem; }
        .my-card.selected { transform: translateY(-12px); background: var(--neon-orange); color: #000; border-color: white; box-shadow: 0 0 15px var(--neon-orange); }
        .my-card.used { opacity: 0; pointer-events: none; }
        
        .main-btn { width: 100%; height: 50px; margin-top: 4px; background: linear-gradient(180deg, var(--neon-blue), #0066cc); border: 1px solid white; border-radius: 6px; font-family: 'Orbitron'; font-size: 1.2rem; color: #fff; font-weight: 900; letter-spacing: 2px; cursor: pointer; box-shadow: 0 4px 0 #004488; transition: 0.1s; text-transform: uppercase; }
        .main-btn:active { transform: translateY(4px); box-shadow: none; }
        .main-btn:disabled { background: #333; color: white; border-color: white; box-shadow: none; cursor: default; }
        .main-btn.attack { background: linear-gradient(180deg, #ff3333, #990000); color: white; box-shadow: 0 4px 0 #550000; }
        .main-btn.sudden { background: yellow; color: black; box-shadow: 0 4px 0 #aaaa00; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        @keyframes safeWinFlash { 0%, 100% { border-color: white; box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); } 50% { border-color: #fff700; box-shadow: 0 0 40px #fff700, inset 0 0 20px #fff700; } }
        .win-pulse { animation: safeWinFlash 0.6s infinite linear !important; z-index: 100; position: relative; }
        .dead-content { filter: brightness(0.4) !important; transition: filter 0.5s ease; }
        
        /* --- Overlays & Modals --- */
        .modal { position: absolute; inset: 0; background: rgba(0,0,0,0.92); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
        .glow-text { animation: textGlow 1.5s infinite alternate; font-family: 'Orbitron'; font-size: 3rem; color:white; }
        @keyframes textGlow { from { text-shadow: 0 0 10px var(--neon-orange); } to { text-shadow: 0 0 30px var(--neon-orange), 0 0 10px white; } }
        
        #cloud-loader { position: fixed; top: 20px; right: 20px; z-index: 10000; display: none; }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(0,234,255,0.3); border-radius: 50%; border-top-color: #00eaff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    
    <div id="cloud-loader"><div class="spinner"></div></div>

    <div class="app-container">
        
        <div id="screen-login" class="screen active" style="justify-content: center; align-items: center;">
            <div style="font-family: 'Orbitron'; font-size: 3rem; text-align: center; color:white; text-shadow: 0 0 20px var(--neon-orange); margin-bottom: 20px;">
                PROJECT<br><span style="color:var(--neon-orange)">CHASER</span>
                <div style="font-size: 0.8rem; color:#aaa; margin-top:10px;">V7.0 MINIKIT</div>
            </div>
            
            <button class="btn btn-world-id" style="width: 260px; height: 50px;" id="btnWorldID">
                <span id="btnIcon" style="font-size: 1.5rem;">‚ö´</span> 
                <span id="btnText">VERIFY WITH WORLD ID</span>
            </button>
            <p id="loginStatus" style="color: #666; font-size: 0.8rem; margin-top: 10px; font-family: 'Kanit';">System Ready</p>
        </div>

        <div id="screen-lobby" class="screen">
            <div class="top-bar" style="height: auto; min-height: 80px; padding-top: 5px; padding-bottom: 5px;">
                <div style="display:flex; align-items:center; flex: 1; min-width: 0;">
                    <div class="avatar" style="margin-right: 10px; width: 55px; height: 55px;">
                        <img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?q=80&w=200">
                    </div>
                    <div style="display: flex; flex-direction: column; justify-content: center; min-width: 0; gap: 2px;">
                        <div style="display:flex; align-items:center; gap: 6px; line-height: 1;">
                            <span id="uiLevel" style="background:var(--neon-blue); color:#000; padding:1px 4px; border-radius:3px; font-size:0.7rem; font-weight:900; font-family:'Orbitron'; flex-shrink: 0;">LV.1</span>
                            <span id="uiPlayerName" style="font-family:'Orbitron'; font-size: 1rem; color:#fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight:bold; letter-spacing:1px; cursor: default;">PLAYER</span> 

                        </div>
                        <div style="font-size: 0.7rem; white-space: nowrap; color:#ccc; line-height: 1.2;">
                            <span style="color:#ff2a2a; font-weight:bold;">‚ù§ <span id="uiLobbyHP">20/20</span></span>
                            <span style="color:#444; margin: 0 4px;">|</span>
                            <span id="uiExp" style="color:#888;">0/150 XP</span>
                        </div>
                        <div style="font-size: 0.8rem; color:#ffd700; font-weight:bold; line-height: 1;">
                            üü° <span id="uiCoin" style="text-shadow:0 0 5px #ffd700;">0</span> COINS
                        </div>
                    </div>
                </div>
                <div id="btnWallet" style="display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; background:rgba(255,255,255,0.05); padding:5px 8px; border-radius:8px; border:1px solid #444; min-width: 65px; margin-left:5px;">
                    <div style="font-size:1.2rem; filter: drop-shadow(0 0 5px #00eaff); line-height: 1;">üíµ</div>
                </div>
            </div>

            <div class="marquee-container"><div class="marquee-text">üéâ SYSTEM: VERIFIED HUMAN DETECTED! - WELCOME TO PROJECT CHASER üëÅÔ∏è</div></div>
            <div class="ad-banner" onclick="window.open('https://www.youtube.com/watch?v=7YtWwxA9sC4')" style="cursor: pointer;">
                <img src="https://github.com/user-attachments/assets/95431a34-e841-4114-967c-797641a63055">
                <div class="ad-tag">AD</div>
            </div>
            <div class="lobby-content">
                <div class="video-box">
                    <div class="video-label">LIVE FEED</div>
                    <iframe width="100%" height="100%" src="https://www.youtube.com/embed/2ohNHqSTu0w?autoplay=1&loop=1&playlist=2ohNHqSTu0w&mute=1&controls=1&showinfo=0&modestbranding=1" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
            <div class="bottom-nav" id="btnStartGame">
                <div class="nav-item">START GAME</div>
            </div>
        </div>

        <div id="screen-map" class="screen screen-white">
            <div class="white-header-bar">
                <h2 style="margin:0; font-family:'Orbitron';">MONSTER HUNT</h2>
                <div class="close-btn" id="btnCloseMap">‚úï</div>
            </div>
            <div id="monster-list-container" style="padding-bottom: 80px;"></div>
        </div>

        <div id="screen-battle" class="screen">
            <div class="header" style="height: 50px; background: rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; padding:0 20px; border-bottom:1px solid #333;">
                <div style="color:white; font-family:'Orbitron'; font-size:1.2rem;">VS <span id="battleEnemyName" style="color:red;">ENEMY</span></div>
            </div>
            <div class="battle-area" id="battleArea">
                <div class="game-column">
                    <div class="boss-banner" id="bossBanner"><img id="bossImg" src="" alt="Boss"></div>
                    <div class="hp-wrapper">
                        <div class="hp-container"><div class="hp-fill hp-enemy" id="enemyHpBar"></div><div class="hp-text" id="enemyHpText">20/20</div></div>
                        <div class="dmg-float" id="eDmgText">-0</div>
                    </div>
                    <div class="card-row" id="enemyCardRow"></div>
                </div>
                <div class="clash-zone" id="clashZone"></div>
                <div class="game-column player-zone">
                    <div class="hp-wrapper">
                        <div class="hp-container"><div class="hp-fill hp-player" id="playerHpBar"></div><div class="hp-text" id="playerHpText">20/20</div></div>
                        <div class="dmg-float" id="pDmgText">-0</div>
                    </div>
                    <div class="card-row" id="playerCardRow"></div>
                    <button id="actionBtn" class="main-btn">SELECT CARDS</button>
                </div>
            </div>
            <div id="resultModal" class="modal">
                <h1 id="resultTitle" class="glow-text">WIN</h1>
                <p id="resultSub" style="color:white;">REWARD: 100 COINS</p>
                <button id="restartBtn" class="main-btn" style="width:220px; margin-top:30px;">CONTINUE</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 4.1 IMPORTS & FIREBASE SETUP ---
        import { MiniKit, Tokens, tokenToDecimals } from "https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@latest/+esm";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"; 
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const APP_ID = "app_6203a46daf3053d01617ef5293135678";
        MiniKit.install(APP_ID);
        console.log("MiniKit Installed");
        window.MiniKit = MiniKit; 

        const firebaseConfig = {
            apiKey: "AIzaSyDPxiP-isMK4VOnwRip2RczXOnqxHSyPtk",
            authDomain: "project-chaser-bc0bd.firebaseapp.com",
            projectId: "project-chaser-bc0bd",
            storageBucket: "project-chaser-bc0bd.firebasestorage.app",
            messagingSenderId: "327717972073",
            appId: "1:327717972073:web:49c32d904243569cd7daf8",
            measurementId: "G-8B45RXBNED"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.REAL_USER_ID = null;
        window.db = db;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc; // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ
        

        // --- 4.2 CLOUD SAVE/LOAD FUNCTIONS ---
        window.cloudSave = async function(data) {
            if(!window.REAL_USER_ID) return;
            const loader = document.getElementById('cloud-loader');
            if(loader) loader.style.display = 'block';
            try {  await setDoc(window.doc(window.db, "users", window.REAL_USER_ID), data, { merge: true }); } 
            catch (e) { console.error("Save Error: ", e); }
            if(loader) loader.style.display = 'none';
        }

        window.cloudLoad = async function(worldID) {
            window.REAL_USER_ID = worldID;
            const loader = document.getElementById('cloud-loader');
            if(loader) loader.style.display = 'block';
            try {
                const docRef = window.doc(window.db, "users", window.REAL_USER_ID);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) window.applyGameData(docSnap.data());
                else window.applyGameData(null);
            } catch (e) {
                console.error("Load Error: ", e);
                window.applyGameData(null);
            }
            if(loader) loader.style.display = 'none';
        }

        window.logWithdrawal = async function(coinAmount, wldAmount) {
    // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ User ID ‡πÑ‡∏´‡∏° (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ window. ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)
    if(!window.REAL_USER_ID) {
        console.warn("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ: ‡πÑ‡∏°‡πà‡∏û‡∏ö User ID");
        return; 
    }

    try {
        // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        const playerName = document.getElementById('uiPlayerName').innerText.trim();
        
        // 2. ‡πÉ‡∏ä‡πâ window. ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ addDoc, collection, ‡πÅ‡∏•‡∏∞ db
        await window.addDoc(window.collection(window.db, "withdrawals"), {
            userId: window.REAL_USER_ID,
            name: playerName,
            coinSpent: coinAmount,       // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Coin ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡πÉ‡∏ô‡πÄ‡∏Å‡∏°
            wldToReceive: wldAmount,     // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô WLD ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
            status: "SUCCESS",           // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏ñ‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô claim ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
            timestamp: new Date().toISOString()
        });
        
        console.log("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á Database ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    } catch (e) { 
        console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô: ", e); 
    }
}

    </script>

    <script>
    // --- 5. GAME LOGIC & GLOBALS ---
    let playerCOIN = 40, playerMaxHP = 20, playerCurrentHP = 20, playerLevel = 1, playerEXP = 0; 
    let earnedFromGameToday = 0;
    let lastRewardDate = new Date().toDateString();
    let currentMonsterType = 'common'; 
    
    // Config
    const levelConfig = { 1: { need: 150, bonus: 2 }, 2: { need: 300, bonus: 2 }, 3: { need: 450, bonus: 2 }, 4: { need: 700, bonus: 2 }, 5: { need: 1000, bonus: 2 } };
    const expReward = { 'common': 1, 'miniboss': 2, 'boss': 3, 'legendary': 5 };
    const monsterDB = [
        { id: 1, name: "Duck Fighter", hp: 20, type: "common", loc: "Sewers", url:"https://images.unsplash.com/photo-1459682687441-7761439a709d?q=80&w=500" },
        { id: 2, name: "Dog Fighter", hp: 20, type: "common", loc: "Sewers", url:"https://github.com/user-attachments/assets/4740cb53-19dd-4186-9c7f-d8af3e3aaddb" },
        { id: 3, name: "Scorpion Fighter", hp: 20, type: "common", loc: "Digital", url:"https://github.com/user-attachments/assets/43953afd-66b6-4ae5-83b9-6121ba7ff05d" },
        { id: 4, name: "Rabbit Fighter", hp: 20, type: "common", loc: "Digital", url:"https://github.com/user-attachments/assets/912e9583-da84-4f1a-adce-e9fe5ae54490" },
        { id: 5, name: "Wolf Fighter", hp: 20, type: "common", loc: "Digital", url:"https://github.com/user-attachments/assets/8e3523b7-7ed7-4d27-b6cf-2f10373738e9" },
        { id: 6, name: "Fire Gobin", hp: 30, type: "miniboss", loc: "Factory", url:"https://github.com/user-attachments/assets/8a354949-f700-4d7e-9ff4-dd5b90164296" }, 
        { id: 7, name: "THE OVERLORD", hp: 40, type: "boss", loc: "Tower", url:"https://github.com/user-attachments/assets/6dec1453-a3f9-4b8f-8499-ac45bd42da29" },
        { id: 8, name: "GOLDEN DRAGON", hp: 50, type: "legendary", loc: "Sky Realm", url:"https://github.com/user-attachments/assets/b8379da1-b55e-4c8f-bcfb-e68eaae581ed" }
    ];

    // --- 6. AUTHENTICATION & LOGIN ---
    document.getElementById('btnWorldID').onclick = async function() {
        const status = document.getElementById('loginStatus');
        status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...";
        status.style.color = "#ff9d00";

        if (!window.MiniKit || !window.MiniKit.isInstalled()) {
            alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App");
            return;
        }

        try {
            const nonce = Math.random().toString(36).substring(7);
            const { finalPayload } = await window.MiniKit.commandsAsync.verify({
                action: 'login',   
                signal: nonce,     
                verification_level: 'device'
            });

            if (finalPayload && finalPayload.status === 'success') {
                status.innerText = "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
                status.style.color = "#00ff00";
                if (window.cloudLoad) await window.cloudLoad(finalPayload.nullifier_hash);
                else window.applyGameData(null); 
            } else {
                console.error("Verify Failed:", finalPayload);
                status.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô";
                status.style.color = "red";
                alert("‚ùå Verify Error: " + (finalPayload.error_code || "Unknown"));
            }
        } catch (error) {
            console.error(error);
            alert("‚ùå Error: " + error.message);
        }
    };

    // --- 7. SAVE & LOAD LOGIC (No Stamp) ---
    function saveGame() {
        const playerName = document.getElementById('uiPlayerName').innerText.trim();
        const gameData = {
            coin: playerCOIN, level: playerLevel, exp: playerEXP,
            hp: playerCurrentHP, name: playerName, earnedFromGameToday: earnedFromGameToday || 0,
            lastRewardDate: lastRewardDate,
            updatedAt: new Date().toISOString()
        };
        if (window.cloudSave) window.cloudSave(gameData);
    }
      //window applyGameDATA

    window.applyGameData = function(data) {

    console.log("üì• Loading Game Data...", data ? "Found Save" : "New User");

    if (data) {
        // ----------------------------------------
        // üíæ ‡∏Å‡∏£‡∏ì‡∏µ: ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡πà‡∏≤ (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firebase)
        // ----------------------------------------
        playerCOIN = parseInt(data.coin) || 0;
        playerLevel = parseInt(data.level) || 1;
        playerEXP = parseInt(data.exp) || 0;
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì HP Max ‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        playerMaxHP = 20 + ((playerLevel - 1) * 2);
        
        // ‡∏ñ‡πâ‡∏≤ HP ‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ï‡πá‡∏°
        playerCurrentHP = parseInt(data.hp) || playerMaxHP; 

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const uiName = document.getElementById('uiPlayerName');
        if (uiName) {
            uiName.innerText = (data.name || "NAME").toUpperCase();
        }

    } else {
        // ----------------------------------------
        // üÜï ‡∏Å‡∏£‡∏ì‡∏µ: ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏û‡∏ö Save)
        // ----------------------------------------
        playerCOIN = 40;       // ‡πÅ‡∏à‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏ß‡∏±‡∏ç‡∏ñ‡∏∏‡∏á
        playerLevel = 1;
        playerEXP = 0;
        playerMaxHP = 20;
        playerCurrentHP = 20;

        // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô "NAME" 
        // (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ First Gate ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠)
        const uiName = document.getElementById('uiPlayerName');
        if (uiName) {
            uiName.innerText = "NAME"; 
        }
    }

    // --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ---
    updateBalance();
    updateLobbyStats();
    initMap(); // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå

    // --- ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π First Gate ‡πÄ‡∏™‡∏°‡∏≠ ---
    // ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°
    openFirstGateModal();

    // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Lobby
    nav('home');
};

        //‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°

         function openFirstGateModal() {

    // üõ° Guard: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≥
    if (document.getElementById("firstGateModal")) return;

    // --- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á UI (Overlay + Box) ---
    const overlay = document.createElement("div");
    overlay.id = "firstGateModal";
    overlay.style.cssText = `
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.95);
        backdrop-filter: blur(10px);
        z-index: 99999;
        display: flex; align-items: center; justify-content: center;
        font-family: 'Orbitron','Kanit',sans-serif;
        animation: fadeIn 0.3s ease-out;
    `;

    const box = document.createElement("div");
    box.style.cssText = `
        width: 85%; max-width: 400px;
        background: #0b0f14;
        border: 1px solid #00eaff;
        border-radius: 12px;
        padding: 30px 20px;
        text-align: center;
        box-shadow: 0 0 30px rgba(0,234,255,0.15);
        position: relative;
    `;

    // --- 2. ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Announcement / Story) ---
    box.innerHTML = `
        <div style="color:#00eaff; font-size:0.8rem; letter-spacing:3px; margin-bottom:10px;">
            SYSTEM ANNOUNCEMENT
        </div>

        <h1 style="
            margin: 0 0 15px;
            font-size: 1.8rem;
            color: #fff;
            text-shadow: 0 0 10px rgba(0,234,255,0.5);
        ">
            PROJECT CHASER
        </h1>

        <div style="
            background: rgba(0,234,255,0.05);
            border: 1px dashed #00eaff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        ">
            <p style="color:#cfefff; font-size:0.9rem; line-height:1.6; margin:0;">
                ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö Hunter!<br>
                ‡πÇ‡∏•‡∏Å‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà<br>
                <span style="color:#ffd700; font-size:0.8rem;">(Beta Version 1.0)</span>
            </p>
        </div>

        <button id="btnEnterGate" style="
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            font-weight: bold;
            color: #000;
            background: linear-gradient(90deg, #00eaff, #008cff);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,234,255,0.3);
            font-family: 'Orbitron', sans-serif;
            transition: transform 0.1s;
        ">
            ENTER WORLD ‚ûî
        </button>
    `;

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // --- 3. Logic ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ---
    const btn = document.getElementById("btnEnterGate");
    
    btn.onclick = () => {
        // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if(typeof playSfx === 'function') playSfx('click');

        // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á First Gate
        overlay.remove();

        // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏°? (Flow ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà)
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å UI ‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ Default (NAME) ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const currentName = document.getElementById('uiPlayerName')?.innerText?.trim();
        
        if (!currentName || currentName === "NAME" || currentName === "UNK") {
            // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà -> ‡πÄ‡∏î‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏ö‡∏ö Sign Wallet ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ô‡∏±‡πâ‡∏ô)
            setTimeout(() => {
                if(typeof changeName === 'function') changeName();
            }, 300); // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
        }
    };
}


    // --- 8. UI HELPERS & NAVIGATION ---
    document.getElementById('btnWallet').onclick = function() {
        gameAlert(
            "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô",
            "‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢ COINS ‡∏à‡∏∞‡πÉ‡∏ä‡πâ WLD ‡∏à‡∏£‡∏¥‡∏á‡∏ú‡πà‡∏≤‡∏ô World App\n‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å World App ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏Ç‡∏∂‡πâ‡∏ô\n‡∏Å‡∏î ACKNOWLEDGE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠",
            function() { openExchangeModal(); }
        );
    };
    document.getElementById('btnStartGame').onclick = () => nav('map');
    document.getElementById('btnCloseMap').onclick = () => nav('home');

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSfx(type) { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); const now = audioCtx.currentTime; osc.connect(gain); gain.connect(audioCtx.destination); if (type === 'click') { osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); } else if (type === 'place') { osc.type = 'sine'; osc.frequency.setValueAtTime(200, now); gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); } else if (type === 'hit') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(10, now + 0.4); gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0, now + 0.4); osc.start(now); osc.stop(now + 0.4); } else if (type === 'win') { osc.type = 'triangle'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(554, now + 0.1); osc.frequency.setValueAtTime(659, now + 0.2); gain.gain.setValueAtTime(0.9, now); gain.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(now); osc.stop(now + 0.5); } }
    
    function updateBalance() { const elCoin = document.getElementById('uiCoin'); if(elCoin) elCoin.innerText = playerCOIN;}
    function updateLobbyStats() { const elLevel = document.getElementById('uiLevel'); const elExp = document.getElementById('uiExp'); const elHP = document.getElementById('uiLobbyHP'); if (!levelConfig[playerLevel]) { if(elLevel) { elLevel.innerText = "LV.MAX"; elLevel.style.color = "#ffd700"; elLevel.style.border = "1px solid #ffd700"; } if(elExp) elExp.innerText = "----/---- XP"; } else { if(elLevel) { elLevel.innerText = "LV." + playerLevel; elLevel.style.color = "#00eaff"; elLevel.style.border = "none"; } if(elExp) { const nextNeed = levelConfig[playerLevel].need; elExp.innerText = `${playerEXP}/${nextNeed} XP`; } } if(elHP) elHP.innerText = `${playerCurrentHP}/${playerMaxHP}`; }
    function nav(target) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); let screenId = 'screen-' + target; if(target === 'home') screenId = 'screen-lobby'; const targetScreen = document.getElementById(screenId); if(targetScreen) targetScreen.classList.add('active'); updateBalance(); updateLobbyStats(); }
    
    function initMap() { const container = document.getElementById('monster-list-container'); if(!container) return; container.innerHTML = ''; monsterDB.forEach(m => { let cardClass = 'rank-common'; let badgeStyle = ''; let infoExtra = ''; if(m.type === 'miniboss') { cardClass = 'rank-miniboss'; badgeStyle = 'color:#00eaff; border-color:#00eaff;'; infoExtra = '<p style="color:#00eaff; font-size:0.7rem; font-weight:bold;">‚òÖ MINI BOSS</p>'; } else if (m.type === 'boss') { cardClass = 'rank-boss'; badgeStyle = 'background:#ffd700; color:black; font-weight:bold; border:none;'; infoExtra = '<p style="color:#ffd700; font-weight:bold; font-size:0.7rem;">‚ò†Ô∏è WORLD BOSS</p>'; } else if (m.type === 'legendary') { cardClass = 'rank-legendary'; badgeStyle = 'background:white; color:#FF8C00; font-weight:900; border:none; box-shadow: 0 0 10px white;'; infoExtra = '<p style="color:white; font-weight:900; font-size:0.8rem; text-shadow: 0 1px 2px black;">üëë LEGENDARY BOSS</p>'; } container.innerHTML += `<div class="monster-card ${cardClass}" onclick="prepareBattle(${m.id})"><div style="display:flex; align-items:center;"><img src="${m.url}" class="m-avatar"><div class="m-info"><h3>${m.name}</h3>${infoExtra}<p>${m.loc} ‚Ä¢ HP: ${m.hp}</p></div></div><div class="hp-badge" style="${badgeStyle}">HP: ${m.hp}</div></div>`; }); }
    
    // =========================================
    // 9. BATTLE LOGIC (Double KO = Rematch x2)
    // =========================================
    let battle_eMaxHP = 20; 
    let battle_eHP = 20; 
    let battle_pDeck = [], battle_eDeck = []; 
    let battle_placedCards = [null, null, null, null, null]; 
    let battle_turn = 0; 
    let battle_isPlaying = false; 
    let currentReward = 0;
    
    let battle_entryFee = 0; 
    let battle_damageMultiplier = 1; // Start at 1x
    
    window.prepareBattle = function(monsterID) { 
        if (playerCOIN < playerMaxHP) { 
            gameAlert("ACCESS DENIED", `‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤!<br>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: <b style="color:#ff0000">${playerMaxHP} COINS</b>`); 
            playSfx('click'); 
            return; 
        } 
              // üåü 2. ‡∏î‡∏±‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Daily Limit ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πâ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) üåü
        const today = new Date().toDateString();
        if (today !== lastRewardDate) {
            earnedFromGameToday = 0;
            lastRewardDate = today;
        }
        
        const dailyGameLimit = 10000;
        if (earnedFromGameToday >= dailyGameLimit) {
            gameAlert("DAILY LIMIT", "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏£‡∏ö 10,000 COINS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!<br><span style='color:#00eaff;'>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ</span>");
            playSfx('click');
            return; // ‚õî ‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πâ
        }

        const monster = monsterDB.find(m => m.id === monsterID); 
        if(!monster) return; 
        
        // Fee deduction
        battle_entryFee = playerMaxHP; 
        playerCOIN -= battle_entryFee;
        saveGame(); 
        updateBalance(); 

        // Battle Setup
        currentMonsterType = monster.type; 
        battle_eMaxHP = monster.hp; 
        battle_eHP = monster.hp; 
        battle_damageMultiplier = 1; // Reset Multiplier

        document.getElementById('battleEnemyName').innerText = monster.name; 
        document.getElementById('bossImg').src = monster.url; 
        
        currentReward = Math.floor(monster.hp * 0.5); 
        
        document.getElementById('screen-battle').style.backgroundImage = "url('https://github.com/user-attachments/assets/13b147e2-f363-49ce-bd43-68530d231a60')"; 
        nav('battle'); 
        initBattleState(); 
    }
    
    function initBattleState() { 
        battle_turn = 0; 
        battle_placedCards = [null, null, null, null, null]; 
        battle_isPlaying = false; 
        document.getElementById('resultModal').style.display = 'none'; 
        updateBattleUI(); 
        
        const currentImg = document.getElementById('bossImg').src; 
        const cZone = document.getElementById('clashZone'); 
        cZone.innerHTML = ''; 
        
        for(let i=0; i<5; i++) { 
            const slot = document.createElement('div'); 
            slot.className = i===0 ? 'clash-slot active' : 'clash-slot'; 
            slot.dataset.id = i; 
            cZone.appendChild(slot); 
        } 
        
        const eRow = document.getElementById('enemyCardRow'); 
        eRow.innerHTML = ''; 
        for(let i=0; i<5; i++) { 
            const wrap = document.createElement('div'); 
            wrap.className = 'card-perspective'; 
            wrap.id = `eWrap${i}`; 
            wrap.innerHTML = `<div class="card-inner"><div class="card-front"style="background-image:url('${currentImg}');background-size:cover; background-position:center;"></div><div class="card-back enemy-revealed" id="eCard${i}">?</div></div>`; 
            eRow.appendChild(wrap); 
        } 
        
        battle_pDeck = [1, 2, 3, 4, 5].sort(() => Math.random() - 0.5); 
        battle_eDeck = [1, 2, 3, 4, 5].sort(() => Math.random() - 0.5); 
        
        const pRow = document.getElementById('playerCardRow'); 
        pRow.innerHTML = ''; 
        battle_pDeck.forEach((val) => { 
            const card = document.createElement('div'); 
            card.className = 'my-card'; 
            card.textContent = val; 
            card.onclick = () => selectCardAction(val, card); 
            pRow.appendChild(card); 
        }); 
        
        const btn = document.getElementById('actionBtn'); 
        btn.textContent = "SELECT CARDS"; 
        btn.disabled = true; 
        btn.className = 'main-btn'; 
        btn.onclick = null; 
        playSfx('place'); 
    }
    
    function selectCardAction(val, el) { 
        if(battle_isPlaying || battle_turn >= 5 || el.classList.contains('used')) return; 
        battle_placedCards[battle_turn] = val; 
        playSfx('click'); 
        
        const slot = document.querySelector(`.clash-slot[data-id="${battle_turn}"]`); 
        slot.innerHTML = `<div>${val}</div>`; 
        slot.classList.remove('active'); 
        el.classList.add('used'); 
        battle_turn++; 
        
        if(battle_turn < 5) { 
            document.querySelector(`.clash-slot[data-id="${battle_turn}"]`).classList.add('active'); 
        } else { 
            const btn = document.getElementById('actionBtn'); 
            btn.textContent = "ATTACK !!!"; 
            btn.disabled = false; 
            btn.classList.add('attack'); 
            btn.onclick = runBattleSequence; 
        } 
    }
    
    async function runBattleSequence() { 
        battle_isPlaying = true; 
        document.getElementById('actionBtn').disabled = true; 
        
        let pSurvivors = []; 
        let eSurvivors = []; 
        
        for(let i=0; i<5; i++) { 
            const eVal = battle_eDeck[i]; 
            const pVal = battle_placedCards[i]; 
            const eWrap = document.getElementById(`eWrap${i}`); 
            const eBack = document.getElementById(`eCard${i}`); 
            eBack.textContent = eVal; 
            eWrap.classList.add('flipped'); 
            playSfx('place'); 
            
            await new Promise(r => setTimeout(r, 600)); 
            
            const pSlot = document.querySelector(`.clash-slot[data-id="${i}"]`); 
            const pCard = pSlot.querySelector('div'); 
            
            if (pVal > eVal) { 
                eBack.classList.add('dead-content'); 
                pCard.parentElement.classList.add('win-pulse'); 
                pSurvivors.push({val: pVal}); 
            } else if (eVal > pVal) { 
                pCard.classList.add('dead-content'); 
                eBack.classList.add('win-pulse'); 
                eSurvivors.push({val: eVal}); 
            } else { 
                eBack.classList.add('dead-content'); 
                pCard.classList.add('dead-content'); 
            } 
            playSfx('click'); 
            await new Promise(r => setTimeout(r, 400)); 
        } 
        
        await new Promise(r => setTimeout(r, 500)); 
        
        // Calculate Damage with Multiplier
        const pCount = pSurvivors.length; 
        const eCount = eSurvivors.length; 
        let dmgToEnemy = 0; 
        let dmgToPlayer = 0; 
        
        if (pCount > eCount) { 
            dmgToEnemy = pSurvivors.reduce((a, b) => a + b.val, 0); 
        } else if (eCount > pCount) { 
            dmgToPlayer = eSurvivors.reduce((a, b) => a + b.val, 0); 
        } else { 
            dmgToEnemy = pSurvivors.reduce((a, b) => a + b.val, 0); 
            dmgToPlayer = eSurvivors.reduce((a, b) => a + b.val, 0); 
        } 
        
        // APPLY MULTIPLIER
        dmgToEnemy *= battle_damageMultiplier;
        dmgToPlayer *= battle_damageMultiplier;

        battle_eHP -= dmgToEnemy; 
        if(dmgToEnemy > 0) flashDamage('e', dmgToEnemy); 
        
        playerCurrentHP -= dmgToPlayer; 
        if(dmgToPlayer > 0) flashDamage('p', dmgToPlayer); 
        if(playerCurrentHP < 0) playerCurrentHP = 0; 
        
        updateBattleUI(); 
        await new Promise(r => setTimeout(r, 1500)); 
        checkBattleResult(); 
    }
    
    function flashDamage(who, amount) { 
        if(amount <= 0) return; 
        const txt = document.getElementById(who === 'e' ? 'eDmgText' : 'pDmgText'); 
        txt.textContent = "-" + amount; 
        txt.classList.add('show'); 
        playSfx('hit'); 
        document.getElementById('battleArea').classList.add('shaking'); 
        if(who === 'e') document.querySelector('.boss-banner').classList.add('hit'); 
        setTimeout(() => { 
            txt.classList.remove('show'); 
            document.getElementById('battleArea').classList.remove('shaking'); 
            document.querySelector('.boss-banner').classList.remove('hit'); 
        }, 800); 
    }

    function updateBattleUI() { 
        if(battle_eHP < 0) battle_eHP = 0; 
        document.getElementById('enemyHpBar').style.width = (battle_eHP/battle_eMaxHP)*100 + "%"; 
        document.getElementById('enemyHpText').textContent = battle_eHP + "/" + battle_eMaxHP; 
        document.getElementById('playerHpBar').style.width = (playerCurrentHP/playerMaxHP)*100 + "%"; 
        document.getElementById('playerHpText').textContent = playerCurrentHP + "/" + playerMaxHP; 
    }
         //9
    
    function checkBattleResult() { 
    const modal = document.getElementById('resultModal'); 
    const title = document.getElementById('resultTitle'); 
    const sub = document.getElementById('resultSub'); 
    const btn = document.getElementById('restartBtn'); 
    
    // ===============================
    // CASE 1: DOUBLE KO ‚Üí REMATCH
    // ===============================
    if (battle_eHP <= 0 && playerCurrentHP <= 0) { 
        title.textContent = "DOUBLE KO"; 
        title.style.color = "yellow"; 

        sub.innerHTML =
            "DRAW! BOTH FALLEN<br>" +
            "<span style='color:red; font-size:1.2rem; font-weight:bold;'>DAMAGE x2</span>"; 
        
        btn.textContent = "REMATCH"; 
        btn.className = "main-btn sudden"; 

        btn.onclick = () => { 
            // ‡∏£‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢
            playerCurrentHP = playerMaxHP; 
            battle_eHP = battle_eMaxHP; 

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° multiplier (‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà x2)
            battle_damageMultiplier = 2;

            updateBattleUI(); 
            initBattleState(); 
        }; 

        modal.style.display = 'flex'; 
        playSfx('win'); 
        return;
    }

    // ===============================
    // CASE 2: PLAYER WINS
    // ===============================
    if (battle_eHP <= 0) {
        // RESET MULTIPLIER ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏π‡πâ‡∏ú‡∏•
        battle_damageMultiplier = 1;

        // ===============================
        // CALC REWARD (BASED ON PLAYER HP)
        // ===============================
        const playerHPPercent = playerCurrentHP / playerMaxHP;
        let baseReward = 0;

        if (playerHPPercent >= 0.5) {
            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‚â• 50% ‚Üí ‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°
            baseReward = battle_eMaxHP;
        } else {
            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠ < 50% ‚Üí ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            baseReward = Math.floor(battle_eMaxHP / 2);
        }

        let totalReward = baseReward + battle_entryFee;

        // ===============================
        // DAILY LIMIT
        // ===============================
        const today = new Date().toDateString();
        if (today !== lastRewardDate) {
            earnedFromGameToday = 0;
            lastRewardDate = today;
        }

        const dailyGameLimit = 10000;
        let actualReceive = totalReward;

        // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡∏≤‡∏ô‡∏µ‡πâ ‡∏ö‡∏ß‡∏Å‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏∞‡∏•‡∏∏‡∏•‡∏¥‡∏°‡∏¥‡∏ï
        if (earnedFromGameToday + baseReward > dailyGameLimit) {
            // ‚úÖ ‡πÉ‡∏ä‡πâ Math.max(0, ...) ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
            let allowedProfit = Math.max(0, dailyGameLimit - earnedFromGameToday); 
            
            actualReceive = allowedProfit + battle_entryFee; // ‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡πÑ‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ + ‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏∑‡∏ô
            gameAlert(
                "‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô",
                `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!<br>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡πÑ‡∏£ ${allowedProfit} (‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏∑‡∏ô ${battle_entryFee})`
            );
        }

        // ===============================
        // APPLY REWARD & EXP
        // ===============================
        playerCOIN += actualReceive;
        earnedFromGameToday += (actualReceive - battle_entryFee);

        let gainedEXP = expReward[currentMonsterType] || 1;
        playerEXP += gainedEXP;

        // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö LEVEL UP ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî•
        let levelUpMessage = ""; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏û
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ EXP ‡∏ñ‡∏∂‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏´‡∏° (‡πÉ‡∏ä‡πâ while ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ EXP ‡∏ó‡∏∞‡∏•‡∏∏‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß 2 ‡πÄ‡∏•‡πÄ‡∏ß‡∏•)
        while (levelConfig[playerLevel] && playerEXP >= levelConfig[playerLevel].need) {
            playerLevel++; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏•‡πÄ‡∏ß‡∏•
            playerMaxHP = 20 + ((playerLevel - 1) * 2); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î MAX ‡∏ï‡∏≤‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
            playerCurrentHP = playerMaxHP; // ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏û: ‡∏£‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°
            
            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Victory
            levelUpMessage = `<br><span style="color:#00ff00; font-size:1.1rem; text-shadow: 0 0 10px #00ff00; animation: pulse 1s infinite;">üéâ LEVEL UP! (LV.${playerLevel})</span>`;
        }

        // ‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢
        saveGame();
        updateLobbyStats();
        updateBalance();

        // ===============================
        // UI
        // ===============================
        title.textContent = "VICTORY";
        title.style.color = "#ff9d00";
        // ‡πÅ‡∏ó‡∏£‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
        sub.innerHTML =
            `REWARD: <span style="color:#00eaff;">+${actualReceive} COINS</span>${levelUpMessage}`;

        btn.textContent = "COLLECT & HUNT";
        btn.className = "main-btn";
        btn.onclick = () => {
            playerCurrentHP = playerMaxHP; // ‡∏£‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            saveGame();
            updateLobbyStats();
            nav('map');
        };

        modal.style.display = 'flex';
        playSfx('win');
        return;
    }

    // ===============================
    // CASE 3: PLAYER LOSES
    // ===============================
    if (playerCurrentHP <= 0) { 
        // RESET MULTIPLIER ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏π‡πâ‡∏ú‡∏•
        battle_damageMultiplier = 1;

        let refund = 0; 
        let msg = "";
        const halfMonsterHP = battle_eMaxHP / 2; 
        
        if (battle_eHP >= halfMonsterHP) { 
            msg =
                `ENEMY TOO STRONG (${battle_eHP} HP LEFT)<br>` +
                `<span style="color:red;">LOST FEE: -${battle_entryFee} COINS</span>`; 
        } else { 
            refund = Math.floor(battle_entryFee / 2); 
            msg =
                `GOOD FIGHT!<br>` +
                `<span style="color:#00eaff;">REFUND: +${refund} COINS</span>`; 
        } 
        
        if (refund > 0) playerCOIN += refund;
        
        saveGame(); 
        updateBalance(); 
        
        title.textContent = "DEFEATED"; 
        title.style.color = "red"; 
        sub.innerHTML = msg; 
        
        btn.textContent = "TRY AGAIN"; 
        btn.className = "main-btn"; 
        btn.onclick = () => { 
            playerCurrentHP = playerMaxHP; 
            saveGame(); 
            updateLobbyStats();
            nav('map'); 
        }; 

        modal.style.display = 'flex'; 
        return;
    }

    // ===============================
    // NEXT ROUND
    // ===============================
    const btnAction = document.getElementById('actionBtn'); 
    btnAction.textContent = "NEXT ROUND"; 
    btnAction.disabled = false; 
    btnAction.classList.remove('attack'); 
    btnAction.onclick = initBattleState; 
}
    
    // --- 10. EXCHANGE SYSTEM & ALERTS ---
    function gameAlert(title, message, callback = null) {
        const oldModal = document.getElementById('customAlert'); if (oldModal) oldModal.remove();
        const overlay = document.createElement('div'); overlay.id = 'customAlert'; overlay.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px);`;
        const box = document.createElement('div'); box.style.cssText = `background: #111; border: 2px solid #ff0000; padding: 20px; width: 80%; max-width: 350px; text-align: center; border-radius: 10px; box-shadow: 0 0 20px rgba(255, 0, 0, 0.4); font-family: 'Kanit', sans-serif; animation: popIn 0.3s ease-out;`;
        box.innerHTML = `<h2 style="color:#ff0000; margin:0 0 10px 0; font-family:'Orbitron'; text-transform:uppercase;">‚õî ${title}</h2><p style="color:#ddd; margin-bottom:20px; font-size:0.9rem; line-height:1.5;">${message}</p><button id="alertBtn" style="background: #ff0000; color: white; border: none; padding: 10px 30px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);">ACKNOWLEDGE</button>`;
        overlay.appendChild(box); document.body.appendChild(overlay);
        const btn = box.querySelector('#alertBtn'); btn.onclick = () => { playSfx('click'); overlay.remove(); if (typeof callback === 'function') { callback(); } };
    }

    window.changeName = function() { 
    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const oldModal = document.getElementById('nameModal'); 
    if (oldModal) oldModal.remove(); 

    const overlay = document.createElement('div'); 
    overlay.id = 'nameModal'; 
    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 10000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(8px); animation: fadeIn 0.3s;`; 
    
    const box = document.createElement('div'); 
    box.style.cssText = `background: #0b0f14; border: 1px solid #00eaff; box-shadow: 0 0 30px rgba(0, 234, 255, 0.2); padding: 30px; width: 90%; max-width: 340px; text-align: center; border-radius: 16px; font-family: 'Kanit', sans-serif;`; 
    
    // (‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î X ‡∏ú‡∏°‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏ô‡∏∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏à‡∏ö)
    
    box.innerHTML = `
        <div style="color:#00eaff; font-family:'Orbitron'; font-size:0.8rem; letter-spacing:2px; margin-bottom:5px;">IDENTITY PROTOCOL</div>
        <h2 style="color:#fff; margin:0 0 20px 0; font-family:'Orbitron';">HUNTER NAME</h2>
        
        <input type="text" id="inpName" placeholder="MAX 8 CHARS" maxlength="8" 
            style="width: 100%; background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 14px; font-family: 'Orbitron'; font-size: 1.4rem; text-align: center; border-radius: 8px; margin-bottom: 20px; outline: none; text-transform: uppercase;">
        
        <button id="btnConfirmName" style="
            width:100%; padding:14px; font-size:1rem; border-radius:8px; border:none; 
            background:linear-gradient(135deg,#00eaff,#008cff); color:#000; font-weight:bold; 
            cursor:pointer; font-family:'Orbitron'; transition:0.2s; box-shadow:0 4px 10px rgba(0,234,255,0.3);
        ">
            CONFIRM & BIND
        </button>
        
        <p style="color:#555; font-size:0.7rem; margin-top:15px; line-height:1.4;">
            * ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∞‡∏ú‡∏π‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ World App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏±‡∏ô‡∏ó‡∏µ<br>
            (Sign Message Only ‚Ä¢ No Gas)
        </p>
    `; 
    
    overlay.appendChild(box); 
    document.body.appendChild(overlay); 
    
    const input = document.getElementById('inpName'); 
    input.focus(); 

    // --- 2. LOGIC ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ---
    const btn = document.getElementById('btnConfirmName');
    
    btn.onclick = async () => { 
        const newName = input.value.trim().toUpperCase(); 
        
        // --- Validation ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ---
        if (!newName) return; 
        if (newName.length > 8) { alert("‚õî ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ! (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)"); return; } 
        const regex = /^[A-Z0-9]+$/; // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏Ñ‡πà A-Z ‡πÅ‡∏•‡∏∞ 0-9 (‡∏ï‡∏±‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡πà‡πÅ‡∏ö‡∏ö‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏™‡πà‡∏Ñ‡∏∑‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ)
        if (!regex.test(newName)) { alert("‚õî ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© A-Z ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 0-9 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"); return; } 

        // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ ---
        try {
            // ‡∏õ‡∏£‡∏±‡∏ö UI ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏•‡∏î
            btn.disabled = true;
            btn.innerText = "1/2 ‚úçÔ∏è SIGNING...";
            btn.style.background = "#333";
            btn.style.color = "#aaa";
            btn.style.boxShadow = "none";

            // 1. ‡πÄ‡∏ä‡πá‡∏Ñ MiniKit
            if (!window.MiniKit || !window.MiniKit.isInstalled()) {
                throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
            }

            // 2. ‡∏™‡∏±‡πà‡∏á Sign Message
            const messageToSign = `Register Hunter: ${newName}\nTimestamp: ${new Date().getTime()}`;
            const signResult = await window.MiniKit.commandsAsync.signMessage({
                message: messageToSign
            });

            const finalPayload = signResult.finalPayload;
            if (finalPayload.status !== "success") {
                throw new Error("User Cancelled Signing");
            }

            // 3. ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!
            const walletAddress = finalPayload.address;
            
            // ‡∏õ‡∏£‡∏±‡∏ö UI ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ã‡∏ü
            btn.innerText = "2/2 üíæ SAVING...";

            // 4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏á Firebase (‡∏ä‡∏∑‡πà‡∏≠ + ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ + ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö REAL_USER_ID ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÑ‡∏´‡∏° (‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà Login)
            if (!window.REAL_USER_ID) throw new Error("User ID Not Found (Login First)");

            await setDoc(window.doc(window.db, "users", window.REAL_USER_ID), {
                name: newName,
                walletAddress: walletAddress,
                walletBound: true,
                coin: 200,          // ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                level: 1,
                hp: 20,
                exp: 0,
                createdAt: new Date().toISOString(),
                walletBoundAt: new Date().toISOString()
            }, { merge: true });

            // --- ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ---
            console.log("‚úÖ Registration Complete:", newName, walletAddress);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            document.getElementById('uiPlayerName').innerText = newName;
            playerCOIN = 200; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡∏î‡πâ‡∏ß‡∏¢
            updateBalance();

            // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
            overlay.remove(); 
            
            // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á & ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            if(typeof playSfx === 'function') playSfx('win');
            gameAlert("WELCOME", `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö Hunter ${newName}!\n‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏∏‡∏Å‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ô‡∏±‡∏Å‡∏•‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì\n...GO>>>>...`);

        } catch (e) {
            console.error("Registration Error:", e);
            
            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
            btn.disabled = false;
            btn.innerText = "TRY AGAIN";
            btn.style.background = "linear-gradient(135deg,#ff4444,#cc0000)"; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏à
            btn.style.color = "#fff";

            if (!e.message.includes("User Cancelled")) {
                alert("‚ùå Error: " + e.message);
            }
        }
    }; 
};

        
   window.openExchangeModal = function() {

    /* =====================================================
     * 1. CONFIGURATION
     * ===================================================== */
    const SELL_RATE = 1100;
    const MIN_SELL = 110;

    const BUY_RATE = 1000;
    const MIN_BUY_WLD = 0.1;

    const RECEIVER = "0x0c07D1879f06B72a0976fe69B777c0BF84410eFa";
    const WITHDRAW_API = "https://game-server-vs0h.onrender.com/api/withdraw";

    /* =====================================================
     * 2. CLEANUP
     * ===================================================== */
    const oldModal = document.getElementById('exchangeModal');
    if (oldModal) oldModal.remove();

    /* =====================================================
     * 3. UI BUILDER (‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ Buy ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
     * ===================================================== */
    const overlay = document.createElement('div');
    overlay.id = 'exchangeModal';
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 10000; display: flex;
        justify-content: center; align-items: center; backdrop-filter: blur(8px);
    `;

    const box = document.createElement('div');
    box.style.cssText = `
        background: #111; border: 1px solid #00eaff; width: 90%; max-width: 400px;
        padding: 20px; border-radius: 12px; font-family: 'Kanit', sans-serif;
        box-shadow: 0 0 30px rgba(0, 234, 255, 0.2); position: relative;
    `;

    box.innerHTML = `
        <div style="position:absolute; top:10px; right:15px; color:#666; cursor:pointer; font-size:1.5rem;"
             onclick="document.getElementById('exchangeModal')?.remove()">√ó</div>

        <h2 style="color:#00eaff; margin:0 0 20px 0; font-family:'Orbitron'; text-align:center;">
            EXCHANGE
        </h2>

        <div style="display:flex; justify-content:space-around; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">
            <div id="tabBuy" style="color:#00eaff; cursor:pointer; font-weight:bold; border-bottom:2px solid #00eaff; flex:1; text-align:center;">
                BUY COINS
            </div>
            <div id="tabSell" style="color:#666; cursor:pointer; flex:1; text-align:center; border-bottom:none;">
                SELL COINS
            </div>
        </div>

        <div id="panelBuy" style="display:block;">
            <p style="color:#aaa; font-size:0.8rem; text-align:center;">
                RATE: 1 WLD = ${BUY_RATE} COINS
            </p>
            <div style="background:#222; padding:15px; border-radius:8px; margin:10px 0;">
                <label style="color:#fff; display:block; margin-bottom:5px;">‡∏à‡πà‡∏≤‡∏¢ WLD</label>
                <input type="number" id="inpBuyWLD" value="${MIN_BUY_WLD}" step="0.1"
                       style="width:100%; background:#000; border:1px solid #444; color:#fff;
                              padding:10px; font-size:1.2rem; font-family:'Orbitron'; text-align:center;">
                <p style="color:#666; font-size:0.7rem; margin-top:5px; text-align:right;">
                    Min: ${MIN_BUY_WLD} WLD
                </p>
            </div>
            <div style="text-align:center; color:#fff; margin-bottom:15px;">
                ‚¨á ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ‚¨á <br>
                <span id="txtGetCoin" style="color:#ffd700; font-size:1.5rem; font-family:'Orbitron';">
                    ${Math.floor(MIN_BUY_WLD * BUY_RATE)}
                </span> COINS
            </div>
            <button id="btnConfirmBuy" class="main-btn"
                    style="width:100%; margin-top:10px; padding:12px; border-radius:8px; background:linear-gradient(135deg,#00eaff,#008cff); color:#000; font-weight:bold; border:none; cursor:pointer;">
                CONFIRM BUY
            </button>
        </div>

        <div id="panelSell" style="display:none;">
            <p style="color:#aaa; font-size:0.8rem; text-align:center;">
                RATE: ${SELL_RATE} COINS = 1 WLD
            </p>
            <div style="background:#222; padding:15px; border-radius:8px; margin:10px 0;">
                <label style="color:#fff; display:block; margin-bottom:5px;">‡∏Ç‡∏≤‡∏¢ COINS</label>
                <input type="number" id="inpSellCoin" value="${MIN_SELL}" step="100"
                       style="width:100%; background:#000; border:1px solid #444; color:#fff;
                              padding:10px; font-size:1.2rem; font-family:'Orbitron'; text-align:center;">
                <p style="color:#666; font-size:0.7rem; margin-top:5px; text-align:right;">
                    Min: ${MIN_SELL} COINS
                </p>
            </div>
            <div style="text-align:center; color:#fff; margin-bottom:15px;">
                ‚¨á ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì) ‚¨á <br>
                <span id="txtGetWLD" style="color:#00eaff; font-size:1.5rem; font-family:'Orbitron';">
                    ${parseFloat((MIN_SELL / SELL_RATE).toFixed(4))}
                </span> WLD
            </div>
            <button id="btnConfirmSell" class="main-btn"
                    style="width:100%; background:#ff4444; border:none; padding:12px; border-radius:8px; color:white; font-weight:bold; cursor:pointer;">
                CONFIRM SELL
            </button>
        </div>
    `;

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    /* =====================================================
     * 4. VARIABLE BINDING & UI EVENTS
     * ===================================================== */
    const inpBuy = document.getElementById('inpBuyWLD');
    const txtGetCoin = document.getElementById('txtGetCoin');
    const inpSell = document.getElementById('inpSellCoin');
    const txtGetWLD = document.getElementById('txtGetWLD');

    document.getElementById('tabBuy').onclick = () => {
        document.getElementById('panelBuy').style.display = 'block';
        document.getElementById('panelSell').style.display = 'none';
        document.getElementById('tabBuy').style.color = '#00eaff';
        document.getElementById('tabBuy').style.borderBottom = '2px solid #00eaff';
        document.getElementById('tabSell').style.color = '#666';
        document.getElementById('tabSell').style.borderBottom = 'none';
    };

    document.getElementById('tabSell').onclick = () => {
        document.getElementById('panelBuy').style.display = 'none';
        document.getElementById('panelSell').style.display = 'block';
        document.getElementById('tabSell').style.color = '#00eaff';
        document.getElementById('tabSell').style.borderBottom = '2px solid #00eaff';
        document.getElementById('tabBuy').style.color = '#666';
        document.getElementById('tabBuy').style.borderBottom = 'none';
    };

    inpBuy.oninput = () => {
        let val = parseFloat(inpBuy.value) || 0;
        txtGetCoin.innerText = Math.floor(val * BUY_RATE);
    };

    inpSell.oninput = () => {
        let val = parseInt(inpSell.value) || 0;
        let rawWLD = val / SELL_RATE;
        txtGetWLD.innerText = parseFloat(rawWLD.toFixed(4)).toString();
    };

    /* =====================================================
     * 5. BUY LOGIC (‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)
     * ===================================================== */
    document.getElementById('btnConfirmBuy').onclick = async function () {
        if (this.disabled) return;
        const btn = this;

        let amountWLD = parseFloat(inpBuy.value) || 0;
        if (amountWLD < MIN_BUY_WLD) return alert(`‚õî ‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Ñ‡∏∑‡∏≠ ${MIN_BUY_WLD} WLD`);
        if (!window.MiniKit?.isInstalled()) return alert("‚õî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App");

        btn.disabled = true;
        btn.innerText = "PROCESSING...";

        try {
            const coinsToReceive = Math.floor(amountWLD * BUY_RATE);
            const amountInWei = BigInt(Math.floor(amountWLD * 1000000)) * 1000000000000n;

            const result = await window.MiniKit.commandsAsync.pay({
                reference: "order_" + Date.now(),
                to: RECEIVER,
                tokens: [{ symbol: "WLD", token_amount: amountInWei.toString() }],
                description: `Buy ${coinsToReceive} COINS`
            });

            if (result?.finalPayload?.status === "success") {
                playerCOIN += coinsToReceive;
                if (typeof updateBalance === 'function') updateBalance();
                if (typeof saveGame === 'function') await saveGame();

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡∏á Firebase (Logging)
                if (window.REAL_USER_ID && window.db) {
                    await window.addDoc(window.collection(window.db, "purchases"), {
                        userId: window.REAL_USER_ID,
                        name: document.getElementById('uiPlayerName')?.innerText || "UNKNOWN",
                        wldSpent: amountWLD,
                        coinReceived: coinsToReceive,
                        timestamp: new Date().toISOString()
                    });
                }
                
                overlay.remove();
                if (typeof gameAlert === 'function') gameAlert("SUCCESS", `‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${coinsToReceive} COINS ‡πÅ‡∏•‡πâ‡∏ß!`);
                else alert(`‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${coinsToReceive} COINS ‡πÅ‡∏•‡πâ‡∏ß!`);
            } else {
                throw new Error("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å");
            }
        } catch (err) {
            console.error("Buy Error:", err);
            if (!err.message?.includes("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å")) alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (err.message || err));
        } finally {
            btn.disabled = false;
            btn.innerText = "CONFIRM BUY";
        }
    };

    /* =====================================================
     * 6. SELL LOGIC (‡∏•‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡πÄ‡∏î‡πâ‡∏á + ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÑ‡∏õ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå)
     * ===================================================== */
    document.getElementById('btnConfirmSell').onclick = async () => {
        const btn = document.getElementById('btnConfirmSell');
        if (btn.disabled) return; 

        const amountCoin = parseInt(inpSell.value) || 0;

        if (amountCoin < MIN_SELL) return alert(`‚õî ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${MIN_SELL} Coins`);
        if (typeof playerCOIN === 'undefined' || playerCOIN < amountCoin) return alert("‚õî Coin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏û‡∏≠!");

        btn.disabled = true;
        btn.innerText = "1/2 VERIFYING..."; // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Server

        try {
            if (!window.MiniKit?.isInstalled()) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App");
            if (!window.REAL_USER_ID) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ID");

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Wallet Address ‡∏à‡∏≤‡∏Å Firebase
            const userDocRef = window.doc(window.db, "users", window.REAL_USER_ID);
            const userDocSnap = await window.getDoc(userDocRef);
            
            if (!userDocSnap.exists() || !userDocSnap.data().walletAddress) {
                throw new Error("‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏π‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô");
            }

            const boundWalletAddress = userDocSnap.data().walletAddress;

            // ‡∏¢‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏´‡πâ Server (‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£ Sign Message ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢)
            const response = await fetch(WITHDRAW_API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId: window.REAL_USER_ID,
                    wallet: boundWalletAddress,   // ‡∏™‡πà‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÉ‡∏´‡πâ Server ‡πÄ‡∏ä‡πá‡∏Ñ/‡πÇ‡∏≠‡∏ô
                    amount: amountCoin,
                    currentCoin: playerCOIN
                })
            });

            const data = await response.json();
            if (!data.success) throw new Error(data.message || "Server Rejected");

            btn.innerText = "2/2 CLAIMING..."; // ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡πâ‡∏á‡πÅ‡∏Ñ‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

            const txPayload = {
                transaction: [{
                    address: data.claimData.vaultAddress,
                    abi: [{ "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "uint256", "name": "nonce", "type": "uint256" }, { "internalType": "bytes", "name": "signature", "type": "bytes" }], "name": "claimReward", "outputs": [], "stateMutability": "nonpayable", "type": "function" }],
                    functionName: "claimReward",
                    args: [ data.claimData.amount, data.claimData.nonce, data.claimData.signature ]
                }]
            };

            const txResult = await window.MiniKit.commandsAsync.sendTransaction(txPayload);

            if (txResult?.finalPayload?.status === "success") {
                // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                if (data.newBalance !== undefined) playerCOIN = data.newBalance;
                else playerCOIN -= amountCoin; 

                if (typeof updateBalance === 'function') updateBalance();
                if (typeof saveGame === 'function') await saveGame();

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Logging)
                if (typeof window.logWithdrawal === 'function') {
                    const expectedWLD = parseFloat((amountCoin / SELL_RATE).toFixed(4));
                    window.logWithdrawal(amountCoin, expectedWLD);
                }

                overlay.remove();
                if (typeof gameAlert === 'function') gameAlert("SUCCESS", "‚úÖ ‡∏ñ‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                else alert("‚úÖ ‡∏ñ‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } else {
                throw new Error("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å");
            }
        } catch (e) {
            console.error("Sell Process Error:", e);
            if (!e.message?.includes("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å")) alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (e.message || "Unknown error"));
        } finally {
            if(btn) {
                btn.disabled = false;
                btn.innerText = "CONFIRM SELL";
            }
        }
    };
};
 

} // <--- ‡∏õ‡∏¥‡∏î function openExchangeModal ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

        
    </script>
</body>
</html>
