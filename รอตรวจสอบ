<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CYBER RPG v7.3 (Double KO Rematch x2)</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;600&family=Orbitron:wght@700;900&display=swap');

        /* --- Global Variables --- */
        :root {
            --neon-orange: #ff9d00;
            --neon-blue: #00eaff;
            --neon-red: #ff2a2a;
            --bg-dark: #050505;
            --bg-white: #f8f9fa;
            --card-width: 54px;
            --card-height: 76px;
            --gap: 6px;
            --total-width: calc((var(--card-width) * 5) + (var(--gap) * 4));
        }

        /* --- Reset & Layout --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body {
            margin: 0; padding: 0;
            background-color: #000;
            font-family: 'Kanit', sans-serif;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        .app-container {
            width: 100%; height: 100%; max-width: 480px;
            background-color: var(--bg-dark);
            position: relative; display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); overflow: hidden;
        }

        /* --- Screens --- */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background-size: cover; background-position: center; }
        .screen.active { display: flex; z-index: 999; }
        .screen-white { background-color: var(--bg-white) !important; color: #333; padding: 20px; overflow-y: auto; background-image: none !important; }
        #screen-login { background-image: url('https://github.com/user-attachments/assets/c9b596d6-88ee-4ca0-bf0a-a80b17ab31f0'); }
        #screen-lobby { background-image: url('https://github.com/user-attachments/assets/70b3047d-bbea-42b8-a8bd-96fe08c69f03'); }

        /* --- UI Components --- */
        .white-header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-top: 5px; color: #333; }
        .close-btn { font-size: 1.5rem; color: #aaa; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background:rgba(255,255,255,0.1); backdrop-filter:blur(5px); }
        .btn { background: linear-gradient(180deg, var(--neon-orange), #d35400); border: none; border-radius: 8px; color: #fff; font-weight: 600; cursor: pointer; padding: 10px; width:100%; font-family: 'Kanit'; }
        
        .btn-world-id {
            background: #ffffff; color: #000000; font-family: 'Orbitron'; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 0 20px rgba(255,255,255,0.4); transition: 0.2s;
        }
        .btn-world-id:active { transform: scale(0.95); box-shadow: 0 0 10px rgba(255,255,255,0.2); }

        /* --- Lobby Elements --- */
        .top-bar { height: 80px; background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent); display: flex; align-items: center; padding: 0 15px; gap: 10px; flex-shrink: 0; color: white; text-shadow: 1px 1px 2px black; justify-content: space-between; }
        .avatar { width: 50px; height: 50px; border: 2px solid var(--neon-orange); border-radius: 50%; background: #333; overflow: hidden; flex-shrink: 0; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .lobby-content { flex: 1; overflow-y: auto; width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 20px; }
        .bottom-nav { height: 70px; background: var(--neon-orange); backdrop-filter: blur(10px); border: 3px solid var(--neon-blue); box-shadow: 0 0 20px rgba(255, 157, 0, 0.4); margin: 0 20px 30px 20px; border-radius: 35px; display: flex; justify-content: center; align-items: center; position: relative; z-index: 100; flex-shrink: 0; animation: pulse 2s infinite; cursor: pointer; }
        .nav-item { text-align: center; color: #000; font-size: 1.8rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; font-family: 'Orbitron'; width: 100%; text-shadow: 0 0 2px rgba(255,255,255,0.5); }

        .ad-banner { width: 100%; max-width: 380px; height: 100px; background: #222; margin: 10px auto; border-radius: 8px; border: 1px solid #444; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; flex-shrink: 0; }
        .ad-banner img { width: 100%; height: 100%; object-fit: cover; }
        .ad-tag { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.5); color: white; font-size: 0.6rem; padding: 2px 5px; }

        .video-box { width: 100%; max-width: 380px; height: 100px; margin: 0 auto 20px auto; border: 2px solid var(--neon-blue); box-shadow: 0 0 15px rgba(0, 234, 255, 0.4); background: #000; position: relative; flex-shrink: 0; }
        .video-label { position: absolute; top: 0; left: 0; background: var(--neon-blue); color: #000; font-family: 'Orbitron'; font-size: 0.5rem; font-weight: bold; padding: 2px 6px; z-index: 10; }
        
        .marquee-container { background: rgba(0,0,0,0.6); border: 1px solid var(--neon-blue); border-radius: 4px; height: 30px; display: flex; align-items: center; overflow: hidden; white-space: nowrap; position: relative; margin: 10px 15px; flex-shrink: 0; }
        .marquee-text { display: inline-block; padding-left: 100%; animation: scroll-left 15s linear infinite; color: var(--neon-blue); font-size: 0.8rem; font-family: 'Kanit'; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* --- Monster Cards --- */
        .monster-card { border-radius: 12px; margin-bottom: 10px; padding: 12px; display: flex; align-items: center; justify-content: space-between; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.1s; }
        .monster-card:active { transform: scale(0.98); }
        .rank-common { background: linear-gradient(135deg, #2c3e50, #4ca1af); }
        .rank-miniboss { background: linear-gradient(135deg, #1e3c72, #2a5298); border: 1px solid var(--neon-blue); }
        .rank-boss { background: linear-gradient(135deg, #8E0E00, #1F1C18); border: 2px solid #ffd700;} 
        .rank-legendary { background: linear-gradient(135deg, #FFD700, #FF8C00);  border: 2px solid white;  box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);  animation: goldPulse 2s infinite; }
        @keyframes goldPulse { 0% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 1); border-color: #fff; } 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); } }
        .m-avatar { width: 50px; height: 50px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); object-fit: cover; margin-right: 15px; }
        .m-info h3 { margin: 0; font-family: 'Orbitron'; font-size: 1rem; }
        .hp-badge { background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-family: 'Orbitron'; border: 1px solid rgba(255,255,255,0.2); min-width: 60px; text-align: center; }

        /* --- Battle System --- */
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        .shaking { animation: shake 0.5s; }
        .battle-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 10px; }
        .game-column { width: var(--total-width); display: flex; flex-direction: column; gap: 6px; }
        .boss-banner { width: 100%; height: 80px; border: 1px solid white; border-radius: 8px; overflow: hidden; background: #000; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .boss-banner img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .boss-banner.hit { border-color: red; animation: shake 0.2s; }
        
        .hp-wrapper { position: relative; width: 100%; margin: 2px 0; }
        .hp-container { width: 100%; height: 20px; background: #222; border: 1px solid white; border-radius: 4px; overflow: hidden; position: relative; }
        .hp-fill { height: 100%; width: 100%; transition: width 0.2s; }
        .hp-enemy { background: linear-gradient(90deg, #ff3333, #aa0000); }
        .hp-player { background: linear-gradient(90deg, #00eaff, #0066cc); }
        .hp-text { position: absolute; width: 100%; text-align: center; top: 0; font-size: 12px; line-height: 20px; color: #fff; font-weight: 900; text-shadow: 1px 1px 2px black; font-family: 'Orbitron'; letter-spacing: 1px; }
        
        .dmg-float { position: absolute; color: #fff; font-weight: 900; font-size: 2.5rem; text-shadow: 2px 2px 0 #ff0000; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); opacity: 0; transition: 0.3s; z-index: 50; font-family: 'Orbitron'; pointer-events: none; }
        .dmg-float.show { opacity: 1; transform: translate(-50%, -100%) scale(1); }
        
        .card-row { display: flex; gap: var(--gap); justify-content: center; width: 100%; height: 80px; margin-top: 4px; }
        .card-perspective { width: var(--card-width); height: var(--card-height); perspective: 1000px; flex-shrink: 0; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 6px; }
        .card-perspective.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-family: 'Orbitron'; font-size: 1.6rem; border: 1px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .card-front { background-color: #1a1a1a; background-image: url('https://images.unsplash.com/photo-1615818386470-3430ee8b3079?q=80&w=200'); background-size: cover; background-position: center; }
        .card-back { background: linear-gradient(135deg, #eee, #ccc); color: #000; transform: rotateY(180deg); font-weight: 900; }
        .card-perspective.flipped .card-back.enemy-revealed { background: linear-gradient(135deg, var(--neon-red), #990000); color: white; border: 1px solid white; box-shadow: 0 0 10px var(--neon-red); }
        
        .clash-zone { width: var(--total-width); height: 90px; display: flex; gap: var(--gap); justify-content: center; align-items: center; border-top: 1px solid rgba(255,255,255,0.2); border-bottom: 1px solid rgba(255,255,255,0.2); }
        .clash-slot { width: var(--card-width); height: var(--card-height); border: 1px solid rgba(255,255,255,0.4); border-radius: 6px; display: flex; align-items: center; justify-content: center; background: transparent; position: relative; flex-shrink: 0; }
        .clash-slot.active { border: 2px solid #fff; background: rgba(0, 234, 255, 0.15); box-shadow: 0 0 15px rgba(0, 234, 255, 0.3); }
        .clash-slot div { width: 100%; height: 100%; background:var(--neon-blue); color: #000; border-radius: 4px; border: 1px solid white; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 1.6rem; font-weight: 900; }
        
        .my-card { width: var(--card-width); height: var(--card-height); flex-shrink: 0; border: 1px solid white; color: var(--neon-orange); background: #111; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron'; font-size: 1.6rem; }
        .my-card.selected { transform: translateY(-12px); background: var(--neon-orange); color: #000; border-color: white; box-shadow: 0 0 15px var(--neon-orange); }
        .my-card.used { opacity: 0; pointer-events: none; }
        
        .main-btn { width: 100%; height: 50px; margin-top: 4px; background: linear-gradient(180deg, var(--neon-blue), #0066cc); border: 1px solid white; border-radius: 6px; font-family: 'Orbitron'; font-size: 1.2rem; color: #fff; font-weight: 900; letter-spacing: 2px; cursor: pointer; box-shadow: 0 4px 0 #004488; transition: 0.1s; text-transform: uppercase; }
        .main-btn:active { transform: translateY(4px); box-shadow: none; }
        .main-btn:disabled { background: #333; color: white; border-color: white; box-shadow: none; cursor: default; }
        .main-btn.attack { background: linear-gradient(180deg, #ff3333, #990000); color: white; box-shadow: 0 4px 0 #550000; }
        .main-btn.sudden { background: yellow; color: black; box-shadow: 0 4px 0 #aaaa00; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        @keyframes safeWinFlash { 0%, 100% { border-color: white; box-shadow: 0 0 5px rgba(255, 255, 255, 0.3); } 50% { border-color: #fff700; box-shadow: 0 0 40px #fff700, inset 0 0 20px #fff700; } }
        .win-pulse { animation: safeWinFlash 0.6s infinite linear !important; z-index: 100; position: relative; }
        .dead-content { filter: brightness(0.4) !important; transition: filter 0.5s ease; }
        
        /* --- Overlays & Modals --- */
        .modal { position: absolute; inset: 0; background: rgba(0,0,0,0.92); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
        .glow-text { animation: textGlow 1.5s infinite alternate; font-family: 'Orbitron'; font-size: 3rem; color:white; }
        @keyframes textGlow { from { text-shadow: 0 0 10px var(--neon-orange); } to { text-shadow: 0 0 30px var(--neon-orange), 0 0 10px white; } }
        
        #cloud-loader { position: fixed; top: 20px; right: 20px; z-index: 10000; display: none; }
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(0,234,255,0.3); border-radius: 50%; border-top-color: #00eaff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    
    <div id="cloud-loader"><div class="spinner"></div></div>

    <div class="app-container">
        
        <div id="screen-login" class="screen active" style="justify-content: center; align-items: center;">
            <div style="font-family: 'Orbitron'; font-size: 3rem; text-align: center; color:white; text-shadow: 0 0 20px var(--neon-orange); margin-bottom: 20px;">
                PROJECT<br><span style="color:var(--neon-orange)">CHASER</span>
                <div style="font-size: 0.8rem; color:#aaa; margin-top:10px;">V7.0 MINIKIT</div>
            </div>
            
            <button class="btn btn-world-id" style="width: 260px; height: 50px;" id="btnWorldID">
                <span id="btnIcon" style="font-size: 1.5rem;">‚ö´</span> 
                <span id="btnText">VERIFY WITH WORLD ID</span>
            </button>
            <p id="loginStatus" style="color: #666; font-size: 0.8rem; margin-top: 10px; font-family: 'Kanit';">System Ready</p>
        </div>

        <div id="screen-lobby" class="screen">
            <div class="top-bar" style="height: auto; min-height: 80px; padding-top: 5px; padding-bottom: 5px;">
                <div style="display:flex; align-items:center; flex: 1; min-width: 0;">
                    <div class="avatar" style="margin-right: 10px; width: 55px; height: 55px;">
                        <img src="https://github.com/user-attachments/assets/027f139b-d81c-4e2d-9feb-9dc0502c8f8b">
                    </div>
                    <div style="display: flex; flex-direction: column; justify-content: center; min-width: 0; gap: 2px;">
                        <div style="display:flex; align-items:center; gap: 6px; line-height: 1;">
                            <span id="uiLevel" style="background:var(--neon-blue); color:#000; padding:1px 4px; border-radius:3px; font-size:0.7rem; font-weight:900; font-family:'Orbitron'; flex-shrink: 0;">LV.1</span>
                            <span id="uiPlayerName" style="font-family:'Orbitron'; font-size: 1rem; color:#fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight:bold; letter-spacing:1px; cursor: default;">PLAYER</span> 

                        </div>
                        <div style="font-size: 0.7rem; white-space: nowrap; color:#ccc; line-height: 1.2;">
                            <span style="color:#ff2a2a; font-weight:bold;">‚ù§ <span id="uiLobbyHP">20/20</span></span>
                            <span style="color:#444; margin: 0 4px;">|</span>
                            <span id="uiExp" style="color:#888;">0/150 XP</span>
                        </div>
                        <div style="font-size: 0.9rem; color:#00ff00; font-weight:bold; line-height: 1;">
                            üü° <span id="uiCoin">0</span> COINS
                        </div>
                    </div>
                </div>
                <div id="btnWallet" style="display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; background:rgba(10,25,40,0.2); padding:5px 8px; border-radius:8px; border:1px solid #444; min-width: 65px; margin-left:5px;">
                    <div style="font-size:2rem; filter: drop-shadow(0 0 5px #00eaff); line-height: 1;">üíµ</div>
                </div>
            </div>

            <div class="marquee-container"><div class="marquee-text">üéâ SYSTEM: VERIFIED HUMAN DETECTED! - WELCOME TO PROJECT CHASER üëÅÔ∏è</div></div>
            <div class="ad-banner" onclick="window.open('https://www.youtube.com/watch?v=7YtWwxA9sC4')" style="cursor: pointer;">
                <img src="https://github.com/user-attachments/assets/95431a34-e841-4114-967c-797641a63055">
                <div class="ad-tag">AD</div>
            </div>
            <div class="lobby-content">
                <div class="video-box">
                    <div class="video-label">LIVE FEED</div>
                    <iframe width="100%" height="100%" src="https://www.youtube.com/embed/2ohNHqSTu0w?autoplay=1&loop=1&playlist=2ohNHqSTu0w&mute=1&controls=1&showinfo=0&modestbranding=1" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
            <div class="bottom-nav" id="btnStartGame">
                <div class="nav-item">START GAME</div>
            </div>
        </div>

        <div id="screen-map" class="screen screen-white">
            <div class="white-header-bar">
                <h2 style="margin:0; font-family:'Orbitron';">MONSTER HUNT</h2>
                <div class="close-btn" id="btnCloseMap">‚úï</div>
            </div>
            
          <div style="background: rgba(10, 25, 40, 0.85); border: 1px solid rgba(0, 234, 255, 0.3); border-radius: 8px; padding: 5px; text-align: center; margin: 10px auto; width: 80%; box-shadow: 0 0 10px rgba(0, 234, 255, 0.05);">
        <div style="color: #aaa; font-size: 0.2rem; font-family: 'Orbitron'; letter-spacing: 1px;">üí∞ REWARD POOL (WLD)</div>
        <div style="color: #00eaff99; font-size: 0.65rem; font-weight: bold; font-family: 'Orbitron'; text-shadow: 0 0 5px #00eaff99;">
            <span id="uiVaultBalance">‚è≥ Loading...</span>
        </div>
    </div>


            <div id="monster-list-container" style="padding-bottom: 80px;"></div>
        </div>

        <div id="screen-battle" class="screen">
            <div class="header" style="height: 50px; background: rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; padding:0 20px; border-bottom:1px solid #333;">
                <div style="color:white; font-family:'Orbitron'; font-size:1.2rem;">VS <span id="battleEnemyName" style="color:red;">ENEMY</span></div>
            </div>
            <div class="battle-area" id="battleArea">
                <div class="game-column">
                    <div class="boss-banner" id="bossBanner"><img id="bossImg" src="" alt="Boss"></div>
                    <div class="hp-wrapper">
                        <div class="hp-container"><div class="hp-fill hp-enemy" id="enemyHpBar"></div><div class="hp-text" id="enemyHpText">20/20</div></div>
                        <div class="dmg-float" id="eDmgText">-0</div>
                    </div>
                    <div class="card-row" id="enemyCardRow"></div>
                </div>
                <div class="clash-zone" id="clashZone"></div>
                <div class="game-column player-zone">
                    <div class="hp-wrapper">
                        <div class="hp-container"><div class="hp-fill hp-player" id="playerHpBar"></div><div class="hp-text" id="playerHpText">20/20</div></div>
                        <div class="dmg-float" id="pDmgText">-0</div>
                    </div>
                    <div class="card-row" id="playerCardRow"></div>
                    <button id="actionBtn" class="main-btn">SELECT CARDS</button>
                </div>
            </div>
            <div id="resultModal" class="modal">
                <h1 id="resultTitle" class="glow-text">WIN</h1>
                <p id="resultSub" style="color:white;">REWARD: 100 COINS</p>
                <button id="restartBtn" class="main-btn" style="width:220px; margin-top:30px;">CONTINUE</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 4.1 IMPORTS (MiniKit Only) ---
        import { MiniKit } from "https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@latest/+esm";

        const APP_ID = "app_6203a46daf3053d01617ef5293135678";
        MiniKit.install(APP_ID);
        console.log("MiniKit Installed");
        window.MiniKit = MiniKit; 
    </script>

    <script>
    // --- 5. GAME LOGIC & GLOBALS ---
    let playerCOIN = 40, playerMaxHP = 20, playerCurrentHP = 20, playerLevel = 1, playerEXP = 0; 
    let earnedFromGameToday = 0;
    let lastRewardDate = new Date().toDateString();
    let currentMonsterType = 'common'; 
    
    // Config
    const levelConfig = { 1: { need: 150, bonus: 2 }, 2: { need: 300, bonus: 2 }, 3: { need: 450, bonus: 2 }, 4: { need: 700, bonus: 2 }, 5: { need: 1000, bonus: 2 } };
    const expReward = { 'common': 1, 'miniboss': 2, 'boss': 3, 'legendary': 5 };
    const monsterDB = [
        { id: 1, name: "Duck Fighter", hp: 20, type: "common", loc: "Sewers", url:"https://images.unsplash.com/photo-1459682687441-7761439a709d?q=80&w=500" },
        { id: 2, name: "Dog Fighter", hp: 20, type: "common", loc: "Sewers", url:"https://github.com/user-attachments/assets/4740cb53-19dd-4186-9c7f-d8af3e3aaddb" },
        { id: 3, name: "Scorpion Fighter", hp: 20, type: "common", loc: "Digital", url:"https://github.com/user-attachments/assets/43953afd-66b6-4ae5-83b9-6121ba7ff05d" },
        { id: 4, name: "Rabbit Fighter", hp: 20, type: "common", loc: "Digital", url:"https://github.com/user-attachments/assets/912e9583-da84-4f1a-adce-e9fe5ae54490" },
        { id: 5, name: "Wolf Fighter", hp: 20, type: "common", loc: "Digital", url:"https://github.com/user-attachments/assets/8e3523b7-7ed7-4d27-b6cf-2f10373738e9" },
        { id: 6, name: "Fire Gobin", hp: 30, type: "miniboss", loc: "Factory", url:"https://github.com/user-attachments/assets/8a354949-f700-4d7e-9ff4-dd5b90164296" }, 
        { id: 7, name: "THE OVERLORD", hp: 40, type: "boss", loc: "Tower", url:"https://github.com/user-attachments/assets/6dec1453-a3f9-4b8f-8499-ac45bd42da29" },
        { id: 8, name: "GOLDEN DRAGON", hp: 50, type: "legendary", loc: "Sky Realm", url:"https://github.com/user-attachments/assets/b8379da1-b55e-4c8f-bcfb-e68eaae581ed" }
    ];

   // --- 6. AUTHENTICATION & LOGIN ---
document.getElementById('btnWorldID').onclick = async function() {
    const status = document.getElementById('loginStatus');
    status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...";
    status.style.color = "#ff9d00";

    if (!window.MiniKit || !window.MiniKit.isInstalled()) {
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App");
        return;
    }

    try {
        const nonce = Math.random().toString(36).substring(7);

        const { finalPayload } = await window.MiniKit.commandsAsync.verify({
            action: 'login',
            signal: nonce,
            verification_level: 'device'
        });

        if (finalPayload && finalPayload.status === 'success') {

            // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á User ID ‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            window.REAL_USER_ID = finalPayload.nullifier_hash;
            console.log("‚úÖ REAL_USER_ID =", window.REAL_USER_ID);

            status.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏•‡πà‡∏≤...";
            status.style.color = "#00eaff";

            // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å Server ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Local/Firebase
            try {
                const res = await fetch("https://game-server-vs0h.onrender.com/api/get-player", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId: window.REAL_USER_ID })
                });
                
                const userData = await res.json();
                if (userData.success && userData.data) {
                    status.innerText = "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö";
                    status.style.color = "#00ff00";
                    window.applyGameData(userData.data);
                } else {
                    status.innerText = "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà";
                    status.style.color = "#00ff00";
                    window.applyGameData(null);
                }
            } catch (apiError) {
                console.warn("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server ‡πÑ‡∏î‡πâ (Fallback)", apiError);
                status.innerText = "‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á (‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà)";
                status.style.color = "yellow";
                window.applyGameData(null);
            }

        } else {
            console.error("Verify Failed:", finalPayload);
            status.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô";
            status.style.color = "red";
            gameAlert("‚ùå Verify Error: " + (finalPayload?.error_code || "Unknown"));
        }

    } catch (error) {
        console.error(error);
        gameAlert("SYSTEM ERROR","‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:<br>" + error.message);
    }
};

    // --- 7. APPLY GAME DATA (Server / New User) ---
    window.applyGameData = function(data) {

    console.log("üì• Loading Game Data...", data ? "Found Save" : "New User");

    if (data) {
        // ----------------------------------------
        // üíæ ‡∏Å‡∏£‡∏ì‡∏µ: ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡πà‡∏≤ (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Database)
        // ----------------------------------------
        playerCOIN = parseInt(data.coin) || 0;
        playerLevel = parseInt(data.level) || 1;
        playerEXP = parseInt(data.exp) || 0;
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì HP Max ‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        playerMaxHP = 20 + ((playerLevel - 1) * 2);
        
        // ‡∏ñ‡πâ‡∏≤ HP ‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ï‡πá‡∏°
        playerCurrentHP = parseInt(data.hp) || playerMaxHP; 

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const uiName = document.getElementById('uiPlayerName');
        if (uiName) {
            uiName.innerText = (data.name || "NAME").toUpperCase();
        }

    } else {
        // ----------------------------------------
        // üÜï ‡∏Å‡∏£‡∏ì‡∏µ: ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏û‡∏ö Save)
        // ----------------------------------------
        playerCOIN = 40;       // ‡πÅ‡∏à‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏ß‡∏±‡∏ç‡∏ñ‡∏∏‡∏á
        playerLevel = 1;
        playerEXP = 0;
        playerMaxHP = 20;
        playerCurrentHP = 20;

        // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô "NAME" 
        // (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ First Gate ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠)
        const uiName = document.getElementById('uiPlayerName');
        if (uiName) {
            uiName.innerText = "NAME"; 
        }
    }

    // --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ---
    updateBalance();
    updateLobbyStats();
    initMap(); // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå

    // --- ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π First Gate ‡πÄ‡∏™‡∏°‡∏≠ ---
    openFirstGateModal();

    // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Lobby
    nav('home');
};

        //‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°

         function openFirstGateModal() {

    // üõ° Guard: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≥
    if (document.getElementById("firstGateModal")) return;

    // --- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á UI (Overlay + Box) ---
    const overlay = document.createElement("div");
    overlay.id = "firstGateModal";
    overlay.style.cssText = `
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.95);
        backdrop-filter: blur(10px);
        z-index: 99999;
        display: flex; align-items: center; justify-content: center;
        font-family: 'Orbitron','Kanit',sans-serif;
        animation: fadeIn 0.3s ease-out;
    `;

    const box = document.createElement("div");
    box.style.cssText = `
        width: 85%; max-width: 400px;
        background: #0b0f14;
        border: 1px solid #00eaff;
        border-radius: 12px;
        padding: 30px 20px;
        text-align: center;
        box-shadow: 0 0 30px rgba(0,234,255,0.15);
        position: relative;
    `;

    // --- 2. ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (Announcement / Story) ---
    box.innerHTML = `
        <div style="color:#00eaff; font-size:0.8rem; letter-spacing:3px; margin-bottom:10px;">
            SYSTEM ANNOUNCEMENT
        </div>

        <h1 style="
            margin: 0 0 15px;
            font-size: 1.8rem;
            color: #fff;
            text-shadow: 0 0 10px rgba(0,234,255,0.5);
        ">
            PROJECT CHASER
        </h1>

        <div style="
            background: rgba(0,234,255,0.05);
            border: 1px dashed #00eaff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        ">
            <p style="color:#cfefff; font-size:0.9rem; line-height:1.6; margin:0;">
                ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö Hunter!<br>
                ‡πÇ‡∏•‡∏Å‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà<br>
                <span style="color:#ffd700; font-size:0.8rem;">(Beta Version 1.0)</span>
            </p>
        </div>

        <button id="btnEnterGate" style="
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            font-weight: bold;
            color: #000;
            background: linear-gradient(90deg, #00eaff, #008cff);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,234,255,0.3);
            font-family: 'Orbitron', sans-serif;
            transition: transform 0.1s;
        ">
            ENTER WORLD ‚ûî
        </button>
    `;

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // --- 3. Logic ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ---
    const btn = document.getElementById("btnEnterGate");
    
    btn.onclick = () => {
        // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if(typeof playSfx === 'function') playSfx('click');

        // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á First Gate
        overlay.remove();

        // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏°? (Flow ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà)
        const currentName = document.getElementById('uiPlayerName')?.innerText?.trim();
        
        if (!currentName || currentName === "NAME" || currentName === "UNK") {
            // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà -> ‡πÄ‡∏î‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏ö‡∏ö Sign Wallet ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ô‡∏±‡πâ‡∏ô)
            setTimeout(() => {
                if(typeof changeName === 'function') changeName();
            }, 300); // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
        }
    };
}


    // --- 8. UI HELPERS & NAVIGATION ---
    document.getElementById('btnWallet').onclick = function() {
        gameAlert(
            "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô",
            "‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢ COINS ‡∏à‡∏∞‡πÉ‡∏ä‡πâ WLD ‡∏à‡∏£‡∏¥‡∏á‡∏ú‡πà‡∏≤‡∏ô World App\n‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å World App ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏Ç‡∏∂‡πâ‡∏ô\n‡∏Å‡∏î ACKNOWLEDGE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠",
            function() { openExchangeModal(); }
        );
    };
    document.getElementById('btnStartGame').onclick = () => nav('map');
    document.getElementById('btnCloseMap').onclick = () => nav('home');

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSfx(type) { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); const now = audioCtx.currentTime; osc.connect(gain); gain.connect(audioCtx.destination); if (type === 'click') { osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); } else if (type === 'place') { osc.type = 'sine'; osc.frequency.setValueAtTime(200, now); gain.gain.setValueAtTime(0.5, now); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); } else if (type === 'hit') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(10, now + 0.4); gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0, now + 0.4); osc.start(now); osc.stop(now + 0.4); } else if (type === 'win') { osc.type = 'triangle'; osc.frequency.setValueAtTime(440, now); osc.frequency.setValueAtTime(554, now + 0.1); osc.frequency.setValueAtTime(659, now + 0.2); gain.gain.setValueAtTime(0.9, now); gain.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(now); osc.stop(now + 0.5); } }
    
    function updateBalance() { const elCoin = document.getElementById('uiCoin'); if(elCoin) elCoin.innerText = playerCOIN;}
    function updateLobbyStats() { const elLevel = document.getElementById('uiLevel'); const elExp = document.getElementById('uiExp'); const elHP = document.getElementById('uiLobbyHP'); if (!levelConfig[playerLevel]) { if(elLevel) { elLevel.innerText = "LV.MAX"; elLevel.style.color = "#ffd700"; elLevel.style.border = "1px solid #ffd700"; } if(elExp) elExp.innerText = "----/---- XP"; } else { if(elLevel) { elLevel.innerText = "LV." + playerLevel; elLevel.style.color = "#00eaff"; elLevel.style.border = "none"; } if(elExp) { const nextNeed = levelConfig[playerLevel].need; elExp.innerText = `${playerEXP}/${nextNeed} XP`; } } if(elHP) elHP.innerText = `${playerCurrentHP}/${playerMaxHP}`; }
    function nav(target) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); let screenId = 'screen-' + target; if(target === 'home') screenId = 'screen-lobby'; const targetScreen = document.getElementById(screenId); if(targetScreen) targetScreen.classList.add('active'); updateBalance(); updateLobbyStats(); }
    
    function initMap() { const container = document.getElementById('monster-list-container'); if(!container) return; container.innerHTML = ''; monsterDB.forEach(m => { let cardClass = 'rank-common'; let badgeStyle = ''; let infoExtra = ''; if(m.type === 'miniboss') { cardClass = 'rank-miniboss'; badgeStyle = 'color:#00eaff; border-color:#00eaff;'; infoExtra = '<p style="color:#00eaff; font-size:0.7rem; font-weight:bold;">‚òÖ MINI BOSS</p>'; } else if (m.type === 'boss') { cardClass = 'rank-boss'; badgeStyle = 'background:#ffd700; color:black; font-weight:bold; border:none;'; infoExtra = '<p style="color:#ffd700; font-weight:bold; font-size:0.7rem;">‚ò†Ô∏è WORLD BOSS</p>'; } else if (m.type === 'legendary') { cardClass = 'rank-legendary'; badgeStyle = 'background:white; color:#FF8C00; font-weight:900; border:none; box-shadow: 0 0 10px white;'; infoExtra = '<p style="color:white; font-weight:900; font-size:0.8rem; text-shadow: 0 1px 2px black;">üëë LEGENDARY BOSS</p>'; } container.innerHTML += `<div class="monster-card ${cardClass}" onclick="prepareBattle(${m.id})"><div style="display:flex; align-items:center;"><img src="${m.url}" class="m-avatar"><div class="m-info"><h3>${m.name}</h3>${infoExtra}<p>${m.loc} ‚Ä¢ HP: ${m.hp}</p></div></div><div class="hp-badge" style="${badgeStyle}">HP: ${m.hp}</div></div>`; });
 }

       // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å World Chain (RPC Tenderly)
async function refreshPoolDisplay() {
    const RPC_URL = 'https://worldchain-mainnet.gateway.tenderly.co'; 
    const WLD_CONTRACT = '0x2cfc85d8e48f8eab294be644d9e25c3030863003';
    
    // 1. ‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const POOL_WALLET = '0x0c07D1879f06B72a0976fe69B777c0BF84410eFa'; 

    const encodedAddress = POOL_WALLET.replace('0x', '').padStart(64, '0');
    const callData = '0x70a08231' + encodedAddress;

    try {
        const response = await fetch(RPC_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                jsonrpc: '2.0',
                id: 1,
                method: 'eth_call',
                params: [{ to: WLD_CONTRACT, data: callData }, 'latest']
            })
        });

        const json = await response.json();
        
        // 2. ‡∏ß‡∏¥‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ uiVaultBalance ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        const uiBalance = document.getElementById('uiVaultBalance');
        
        if (json.result && json.result !== '0x') {
            const balanceInWei = BigInt(json.result);
            const balanceInWLD = Number(balanceInWei) / 1e18;

            // 3. ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏ô‡∏µ‡∏≠‡∏≠‡∏ô
            uiBalance.innerText = balanceInWLD.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            uiBalance.style.color = "#00eaff";
            uiBalance.style.fontSize = "1.2rem";
            
            console.log("Pool Updated:", balanceInWLD);
        } else {
            uiBalance.innerText = "‚ö†Ô∏è BUSY"; 
            uiBalance.style.color = "#ffaa00";
        }
    } catch (error) {
        console.error("‡πÇ‡∏ä‡∏ß‡πå‡∏¢‡∏≠‡∏î Pool ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error);
        const uiBalance = document.getElementById('uiVaultBalance');
        if(uiBalance) {
            uiBalance.innerText = "‚ùå OFFLINE";
            uiBalance.style.color = "#ff2a2a";
        }
    }
}

// ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°
refreshPoolDisplay();

// ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏ó‡∏∏‡∏Å‡πÜ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (30000 ‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
setInterval(refreshPoolDisplay, 30000);
    
    // =========================================
    // 9. BATTLE LOGIC (Double KO = Rematch x2)
    // =========================================
    let battle_eMaxHP = 20; 
    let battle_eHP = 20; 
    let battle_pDeck = [], battle_eDeck = []; 
    let battle_placedCards = [null, null, null, null, null]; 
    let battle_turn = 0; 
    let battle_isPlaying = false; 
    let currentReward = 0;
    
    let battle_entryFee = 0; 
    let battle_damageMultiplier = 1; // Start at 1x
    
    window.prepareBattle = async function(monsterID) { 
        // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏¥‡∏á API)
        if (playerCOIN < playerMaxHP) { 
            gameAlert("ACCESS DENIED", `‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤!<br>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: <b style="color:#ff0000">${playerMaxHP} COINS</b>`); 
            playSfx('click'); 
            return; 
        } 
        
        // 2. ‡∏î‡∏±‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Daily Limit
        const today = new Date().toDateString();
        if (today !== lastRewardDate) {
            earnedFromGameToday = 0;
            lastRewardDate = today;
        }
        
        const dailyGameLimit = 10000;
        if (earnedFromGameToday >= dailyGameLimit) {
            gameAlert("DAILY LIMIT", "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏£‡∏ö 10,000 COINS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!<br><span style='color:#00eaff;'>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ</span>");
            playSfx('click');
            return; 
        }

        const monster = monsterDB.find(m => m.id === monsterID); 
        if(!monster) return; 

        // üåü 3. ‡∏¢‡∏¥‡∏á API ‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ö‡∏≠‡∏™ ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        try {
            // ‡πÇ‡∏ä‡∏ß‡πå‡πÇ‡∏´‡∏•‡∏î‡∏î‡∏¥‡∏á (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ô‡∏Å‡∏î‡∏¢‡πâ‡∏≥‡πÜ)
            const loader = document.getElementById('cloud-loader');
            if (loader) loader.style.display = 'block';

            const response = await fetch("https://game-server-vs0h.onrender.com/api/battle-start", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId: window.REAL_USER_ID,
                    monsterId: monster.id
                })
            });

            const data = await response.json();
            if (loader) loader.style.display = 'none';

            if (!data.success) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á Alert ‡πÅ‡∏•‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á
                throw new Error(data.message);
            }

            // üåü 4. ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô! ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏î‡∏•‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            playerCOIN = data.newBalance;
            battle_entryFee = playerMaxHP; 
            updateBalance();

            // 5. ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏π‡πâ
            window.currentMonsterId = monsterID; 
            currentMonsterType = monster.type; 
            battle_eMaxHP = monster.hp; 
            battle_eHP = monster.hp; 
            battle_damageMultiplier = 1; 

            document.getElementById('battleEnemyName').innerText = monster.name; 
            document.getElementById('bossImg').src = monster.url; 
            currentReward = Math.floor(monster.hp * 0.5); 
            
            document.getElementById('screen-battle').style.backgroundImage = "url('https://github.com/user-attachments/assets/13b147e2-f363-49ce-bd43-68530d231a60')"; 
            nav('battle'); 
            initBattleState(); 

        } catch (err) {
            console.error("Battle Start Error:", err);
            gameAlert("SYSTEM ERROR", err.message || "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
        }
    }
    
    function initBattleState() { 
        battle_turn = 0; 
        battle_placedCards = [null, null, null, null, null]; 
        battle_isPlaying = false; 
        document.getElementById('resultModal').style.display = 'none'; 
        updateBattleUI(); 
        
        const currentImg = document.getElementById('bossImg').src; 
        const cZone = document.getElementById('clashZone'); 
        cZone.innerHTML = ''; 
        
        for(let i=0; i<5; i++) { 
            const slot = document.createElement('div'); 
            slot.className = i===0 ? 'clash-slot active' : 'clash-slot'; 
            slot.dataset.id = i; 
            cZone.appendChild(slot); 
        } 
        
        const eRow = document.getElementById('enemyCardRow'); 
        eRow.innerHTML = ''; 
        for(let i=0; i<5; i++) { 
            const wrap = document.createElement('div'); 
            wrap.className = 'card-perspective'; 
            wrap.id = `eWrap${i}`; 
            wrap.innerHTML = `<div class="card-inner"><div class="card-front"style="background-image:url('${currentImg}');background-size:cover; background-position:center;"></div><div class="card-back enemy-revealed" id="eCard${i}">?</div></div>`; 
            eRow.appendChild(wrap); 
        } 
        
        battle_pDeck = [1, 2, 3, 4, 5].sort(() => Math.random() - 0.5); 
        battle_eDeck = [1, 2, 3, 4, 5].sort(() => Math.random() - 0.5); 
        
        const pRow = document.getElementById('playerCardRow'); 
        pRow.innerHTML = ''; 
        battle_pDeck.forEach((val) => { 
            const card = document.createElement('div'); 
            card.className = 'my-card'; 
            card.textContent = val; 
            card.onclick = () => selectCardAction(val, card); 
            pRow.appendChild(card); 
        }); 
        
        const btn = document.getElementById('actionBtn'); 
        btn.textContent = "SELECT CARDS"; 
        btn.disabled = true; 
        btn.className = 'main-btn'; 
        btn.onclick = null; 
        playSfx('place'); 
    }
    
    function selectCardAction(val, el) { 
        if(battle_isPlaying || battle_turn >= 5 || el.classList.contains('used')) return; 
        battle_placedCards[battle_turn] = val; 
        playSfx('click'); 
        
        const slot = document.querySelector(`.clash-slot[data-id="${battle_turn}"]`); 
        slot.innerHTML = `<div>${val}</div>`; 
        slot.classList.remove('active'); 
        el.classList.add('used'); 
        battle_turn++; 
        
        if(battle_turn < 5) { 
            document.querySelector(`.clash-slot[data-id="${battle_turn}"]`).classList.add('active'); 
        } else { 
            const btn = document.getElementById('actionBtn'); 
            btn.textContent = "ATTACK !!!"; 
            btn.disabled = false; 
            btn.classList.add('attack'); 
            btn.onclick = runBattleSequence; 
        } 
    }
    
    async function runBattleSequence() { 
        battle_isPlaying = true; 
        document.getElementById('actionBtn').disabled = true; 
        
        let pSurvivors = []; 
        let eSurvivors = []; 
        
        for(let i=0; i<5; i++) { 
            const eVal = battle_eDeck[i]; 
            const pVal = battle_placedCards[i]; 
            const eWrap = document.getElementById(`eWrap${i}`); 
            const eBack = document.getElementById(`eCard${i}`); 
            eBack.textContent = eVal; 
            eWrap.classList.add('flipped'); 
            playSfx('place'); 
            
            await new Promise(r => setTimeout(r, 600)); 
            
            const pSlot = document.querySelector(`.clash-slot[data-id="${i}"]`); 
            const pCard = pSlot.querySelector('div'); 
            
            if (pVal > eVal) { 
                eBack.classList.add('dead-content'); 
                pCard.parentElement.classList.add('win-pulse'); 
                pSurvivors.push({val: pVal}); 
            } else if (eVal > pVal) { 
                pCard.classList.add('dead-content'); 
                eBack.classList.add('win-pulse'); 
                eSurvivors.push({val: eVal}); 
            } else { 
                eBack.classList.add('dead-content'); 
                pCard.classList.add('dead-content'); 
            } 
            playSfx('click'); 
            await new Promise(r => setTimeout(r, 400)); 
        } 
        
        await new Promise(r => setTimeout(r, 500)); 
        
        // Calculate Damage with Multiplier
        const pCount = pSurvivors.length; 
        const eCount = eSurvivors.length; 
        let dmgToEnemy = 0; 
        let dmgToPlayer = 0; 
        
        if (pCount > eCount) { 
            dmgToEnemy = pSurvivors.reduce((a, b) => a + b.val, 0); 
        } else if (eCount > pCount) { 
            dmgToPlayer = eSurvivors.reduce((a, b) => a + b.val, 0); 
        } else { 
            dmgToEnemy = pSurvivors.reduce((a, b) => a + b.val, 0); 
            dmgToPlayer = eSurvivors.reduce((a, b) => a + b.val, 0); 
        } 
        
        // APPLY MULTIPLIER
        dmgToEnemy *= battle_damageMultiplier;
        dmgToPlayer *= battle_damageMultiplier;

        battle_eHP -= dmgToEnemy; 
        if(dmgToEnemy > 0) flashDamage('e', dmgToEnemy); 
        
        playerCurrentHP -= dmgToPlayer; 
        if(dmgToPlayer > 0) flashDamage('p', dmgToPlayer); 
        if(playerCurrentHP < 0) playerCurrentHP = 0; 
        
        updateBattleUI(); 
        await new Promise(r => setTimeout(r, 1500)); 
        checkBattleResult(); 
    }
    
    function flashDamage(who, amount) { 
        if(amount <= 0) return; 
        const txt = document.getElementById(who === 'e' ? 'eDmgText' : 'pDmgText'); 
        txt.textContent = "-" + amount; 
        txt.classList.add('show'); 
        playSfx('hit'); 
        document.getElementById('battleArea').classList.add('shaking'); 
        if(who === 'e') document.querySelector('.boss-banner').classList.add('hit'); 
        setTimeout(() => { 
            txt.classList.remove('show'); 
            document.getElementById('battleArea').classList.remove('shaking'); 
            document.querySelector('.boss-banner').classList.remove('hit'); 
        }, 800); 
    }

    function updateBattleUI() { 
        if(battle_eHP < 0) battle_eHP = 0; 
        document.getElementById('enemyHpBar').style.width = (battle_eHP/battle_eMaxHP)*100 + "%"; 
        document.getElementById('enemyHpText').textContent = battle_eHP + "/" + battle_eMaxHP; 
        document.getElementById('playerHpBar').style.width = (playerCurrentHP/playerMaxHP)*100 + "%"; 
        document.getElementById('playerHpText').textContent = playerCurrentHP + "/" + playerMaxHP; 
    }
       
    
     // =========================================
    // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ (Double KO x2, Server Sync, ‡∏Å‡∏î NEXT ROUND ‡πÄ‡∏≠‡∏á)
    // =========================================

    async function checkBattleResult() { 
        const modal = document.getElementById('resultModal'); 
        const title = document.getElementById('resultTitle'); 
        const sub = document.getElementById('resultSub'); 
        const btn = document.getElementById('restartBtn'); 
        
        // --- 1. DOUBLE KO ‚Üí REMATCH (DAMAGE x2 ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà) ---
        if (battle_eHP <= 0 && playerCurrentHP <= 0) { 
            title.textContent = "DOUBLE KO"; 
            title.style.color = "yellow"; 
            sub.innerHTML = "DRAW! BOTH FALLEN<br><span style='color:red; font-size:1.2rem; font-weight:bold;'>DAMAGE x2</span>"; 
            btn.textContent = "REMATCH"; 
            btn.className = "main-btn sudden"; 
            btn.onclick = () => { 
                playerCurrentHP = playerMaxHP; 
                battle_eHP = battle_eMaxHP; 
                battle_damageMultiplier = 2; // ‡∏Ñ‡∏π‡∏ì 2
                updateBattleUI(); 
                initBattleState(); 
            }; 
            modal.style.display = 'flex'; 
            playSfx('win'); 
            return;
        }

        // --- 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ú‡∏•‡πÅ‡∏û‡πâ‡∏ä‡∏ô‡∏∞ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏¥‡∏á Server ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•) ---
        let battleResult = "";
        let pHPPercent = playerCurrentHP / playerMaxHP;
        let enemyHpPercent = battle_eHP / battle_eMaxHP;

        if (battle_eHP <= 0) battleResult = "win";
        else if (playerCurrentHP <= 0) battleResult = "lose";

        if (battleResult) {
            // ‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ô‡∏Å‡∏î‡πÄ‡∏ö‡∏¥‡πâ‡∏•
            const btnAction = document.getElementById('actionBtn'); 
            btnAction.disabled = true;
            btnAction.innerText = "‚è≥ WAIT...";

            try {
                // ‡∏¢‡∏¥‡∏á API ‡∏ö‡∏≠‡∏Å Server ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                const response = await fetch("https://game-server-vs0h.onrender.com/api/battle-result", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        userId: window.REAL_USER_ID,
                        monsterId: window.currentMonsterId,
                        result: battleResult,
                        playerHpPercent: pHPPercent,
                        enemyHpPercent: enemyHpPercent
                    })
                });

                const resData = await response.json();
                if (!resData.success) throw new Error(resData.message);

                const serverData = resData.data; 

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Database
                playerCOIN = serverData.coin;
                playerLevel = serverData.level;
                playerEXP = serverData.exp;
                playerMaxHP = serverData.hp;
                earnedFromGameToday = serverData.earnedFromGameToday;
                lastRewardDate = serverData.lastRewardDate;

                updateLobbyStats();
                updateBalance();

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                if (battleResult === "win") {
                    title.textContent = "VICTORY";
                    title.style.color = "#ff9d00";

                    if (serverData.hitDailyLimit) {
                        gameAlert(
                            "‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô",
                            `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!<br>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡πÑ‡∏£ ${serverData.allowedProfit} (‡∏ó‡∏∏‡∏ô‡∏Ñ‡∏∑‡∏ô ${serverData.entryFee})`
                        );
                    }

                    let levelUpMsg = serverData.isLevelUp ? `<br><span style="color:#00ff00; font-size:1.1rem; text-shadow: 0 0 10px #00ff00; animation: pulse 1s infinite;">üéâ LEVEL UP! (LV.${playerLevel})</span>` : "";
                    sub.innerHTML = `REWARD: <span style="color:#00eaff;">+${serverData.rewardCoin} COINS</span>${levelUpMsg}`;

                    btn.textContent = "COLLECT & HUNT";
                    btn.className = "main-btn";
                    btn.onclick = () => {
                        playerCurrentHP = playerMaxHP; 
                        updateLobbyStats();
                        nav('map');
                    };
                    playSfx('win');
                } else {
                    title.textContent = "DEFEATED";
                    title.style.color = "red";

                    let refundMsg = serverData.feeRefund > 0 
                        ? `<br><span style="color:#00eaff;">REFUND: +${serverData.feeRefund} COINS</span>` 
                        : `<br><span style="color:red;">LOST FEE: -${serverData.entryFee} COINS</span>`;
                    
                    let battleFeedback = serverData.feeRefund > 0 ? "GOOD FIGHT!" : "ENEMY TOO STRONG";
                    sub.innerHTML = `${battleFeedback}${refundMsg}`;

                    btn.textContent = "TRY AGAIN";
                    btn.className = "main-btn";
                    btn.onclick = () => {
                        playerCurrentHP = playerMaxHP; 
                        updateLobbyStats();
                        nav('map');
                    };
                }

                modal.style.display = 'flex';

            } catch (err) {
                console.error(err);
                gameAlert("SYNC ERROR", "‚ùå ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå:<br>" + err.message);
                
                btnAction.disabled = false;
                btnAction.innerText = "RETRY SYNC";
                btnAction.onclick = checkBattleResult; 
            }
        } else {
            // --- 3. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°: ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏£‡∏ö 5 ‡πÉ‡∏ö ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà (‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î NEXT ROUND ‡πÄ‡∏≠‡∏á) ---
            const btnAction = document.getElementById('actionBtn'); 
            btnAction.innerText = "NEXT ROUND"; 
            btnAction.disabled = false; // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ
            btnAction.className = "main-btn"; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
            
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏à‡∏Å‡πÑ‡∏û‡πà‡πÉ‡∏´‡∏°‡πà
            btnAction.onclick = () => {
                if(typeof playSfx === 'function') playSfx('click');
                initBattleState(); 
            };
        }
    }

    // --- 10. EXCHANGE SYSTEM & ALERTS ---
    function gameAlert(title, message, callback = null) {
        const oldModal = document.getElementById('customAlert'); if (oldModal) oldModal.remove();
        const overlay = document.createElement('div'); overlay.id = 'customAlert'; overlay.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px);`;
        const box = document.createElement('div'); box.style.cssText = `background: #111; border: 2px solid #ff0000; padding: 20px; width: 80%; max-width: 350px; text-align: center; border-radius: 10px; box-shadow: 0 0 20px rgba(255, 0, 0, 0.4); font-family: 'Kanit', sans-serif; animation: popIn 0.3s ease-out;`;
        box.innerHTML = `<h2 style="color:#ff0000; margin:0 0 10px 0; font-family:'Orbitron'; text-transform:uppercase;">‚õî ${title}</h2><p style="color:#ddd; margin-bottom:20px; font-size:0.9rem; line-height:1.5;">${message}</p><button id="alertBtn" style="background: #ff0000; color: white; border: none; padding: 10px 30px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);">ACKNOWLEDGE</button>`;
        overlay.appendChild(box); document.body.appendChild(overlay);
        const btn = box.querySelector('#alertBtn'); btn.onclick = () => { playSfx('click'); overlay.remove(); if (typeof callback === 'function') { callback(); } };
    }

    window.changeName = function() { 
    // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const oldModal = document.getElementById('nameModal'); 
    if (oldModal) oldModal.remove(); 

    const overlay = document.createElement('div'); 
    overlay.id = 'nameModal'; 
    overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 10000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(8px); animation: fadeIn 0.3s;`; 
    
    const box = document.createElement('div'); 
    box.style.cssText = `background: #0b0f14; border: 1px solid #00eaff; box-shadow: 0 0 30px rgba(0, 234, 255, 0.2); padding: 30px; width: 90%; max-width: 340px; text-align: center; border-radius: 16px; font-family: 'Kanit', sans-serif;`; 
    
    box.innerHTML = `
        <div style="color:#00eaff; font-family:'Orbitron'; font-size:0.8rem; letter-spacing:2px; margin-bottom:5px;">IDENTITY PROTOCOL</div>
        <h2 style="color:#fff; margin:0 0 20px 0; font-family:'Orbitron';">HUNTER NAME</h2>
        
        <input type="text" id="inpName" placeholder="MAX 8 CHARS" maxlength="8" 
            style="width: 100%; background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 14px; font-family: 'Orbitron'; font-size: 1.4rem; text-align: center; border-radius: 8px; margin-bottom: 20px; outline: none; text-transform: uppercase;">
        
        <button id="btnConfirmName" style="
            width:100%; padding:14px; font-size:1rem; border-radius:8px; border:none; 
            background:linear-gradient(135deg,#00eaff,#008cff); color:#000; font-weight:bold; 
            cursor:pointer; font-family:'Orbitron'; transition:0.2s; box-shadow:0 4px 10px rgba(0,234,255,0.3);
        ">
            CONFIRM
        </button>
        
        <p style="color:#555; font-size:0.7rem; margin-top:15px; line-height:1.4;">
            * üî¥üü†üü°üü¢üîµüü£üü§‚ö™Ô∏è‚ö´Ô∏è<br>
            (Sign Message Only ‚ù§)
        </p>
    `; 
    
    overlay.appendChild(box); 
    document.body.appendChild(overlay); 
    
    const input = document.getElementById('inpName'); 
    input.focus(); 

    // --- 2. LOGIC ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ---
    const btn = document.getElementById('btnConfirmName');
    
    btn.onclick = async () => { 
        const newName = input.value.trim().toUpperCase(); 
        
        // --- Validation ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ---
        if (!newName) return; 
        if (newName.length > 8) { alert("‚õî ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ! (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)"); return; } 
        const regex = /^[A-Z0-9]+$/; // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏Ñ‡πà A-Z ‡πÅ‡∏•‡∏∞ 0-9
        if (!regex.test(newName)) { alert("‚õî ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© A-Z ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 0-9 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"); return; } 

        // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ ---
        try {
            btn.disabled = true;
            btn.innerText = "‚è≥Ô∏è WAIT...";
            btn.style.background = "#333";
            btn.style.color = "#aaa";
            btn.style.boxShadow = "none";

            // 1. ‡πÄ‡∏ä‡πá‡∏Ñ MiniKit
            if (!window.MiniKit || !window.MiniKit.isInstalled()) {
                throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
            }

            // 2. ‡∏™‡∏±‡πà‡∏á Sign Message
            const messageToSign = `Register Hunter: ${newName}\nTimestamp: ${new Date().getTime()}`;
            const signResult = await window.MiniKit.commandsAsync.signMessage({
                message: messageToSign
            });

            const finalPayload = signResult.finalPayload;
            if (finalPayload.status !== "success") {
                throw new Error("User Cancelled Signing");
            }

            // 3. ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!
            const walletAddress = finalPayload.address;
            
       
            // 4. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏´‡πâ Server ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ó‡∏ô
            if (!window.REAL_USER_ID) throw new Error("User ID Not Found (Login First)");

            const response = await fetch("https://game-server-vs0h.onrender.com/api/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId: window.REAL_USER_ID,
                    wallet: walletAddress,
                    name: newName
                })
            });

            const data = await response.json();
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Server ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏´‡∏° (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ã‡πâ‡∏≥)
            if (!data.success) {
                throw new Error(data.message || "‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô");
            }

            // --- ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ---
            console.log("‚úÖ Registration Complete by Server:", newName, walletAddress);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà Server ‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
            document.getElementById('uiPlayerName').innerText = newName;
            playerCOIN = 40;     // ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏ß‡∏±‡∏ç‡∏ñ‡∏∏‡∏á 40 ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç
            playerLevel = 1;     // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏• 1
            playerEXP = 0;
            playerMaxHP = 20;
            playerCurrentHP = 20;
            
            // ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            updateBalance();
            updateLobbyStats();

            // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
            overlay.remove(); 
            
            // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á & ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            if(typeof playSfx === 'function') playSfx('win');
            gameAlert("WELCOME", `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö Hunter ${newName}!\n‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö 40 COINS ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô\n...GO>>>>...`);

        } catch (e) {
            console.error("Registration Error:", e);
            
            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
            btn.disabled = false;
            btn.innerText = "TRY AGAIN";
            btn.style.background = "linear-gradient(135deg,#ff4444,#cc0000)"; 
            btn.style.color = "#fff";

            if (!e.message.includes("User Cancelled")) {
                gameAlert("Error","‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ:<br>"+ e.message);
            }
        }
    }; 
};

   window.openExchangeModal = function() {

    /* =====================================================
     * 1. CONFIGURATION
     * ===================================================== */
    const SELL_RATE = 1100;
    const MIN_SELL = 110;

    const BUY_RATE = 1000;
    const MIN_BUY_WLD = 0.1;

    const RECEIVER = "0x0c07D1879f06B72a0976fe69B777c0BF84410eFa";
    const WITHDRAW_API = "https://game-server-vs0h.onrender.com/api/withdraw";

    /* =====================================================
     * 2. CLEANUP
     * ===================================================== */
    const oldModal = document.getElementById('exchangeModal');
    if (oldModal) oldModal.remove();

    /* =====================================================
     * 3. UI BUILDER
     * ===================================================== */
    const overlay = document.createElement('div');
    overlay.id = 'exchangeModal';
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 10000; display: flex;
        justify-content: center; align-items: center; backdrop-filter: blur(8px);
    `;

    const box = document.createElement('div');
    box.style.cssText = `
        background: #111; border: 1px solid #00eaff; width: 90%; max-width: 400px;
        padding: 20px; border-radius: 12px; font-family: 'Kanit', sans-serif;
        box-shadow: 0 0 30px rgba(0, 234, 255, 0.2); position: relative;
    `;

    box.innerHTML = `
        <div style="position:absolute; top:10px; right:15px; color:#666; cursor:pointer; font-size:1.5rem;"
             onclick="document.getElementById('exchangeModal')?.remove()">√ó</div>

        <h2 style="color:#00eaff; margin:0 0 20px 0; font-family:'Orbitron'; text-align:center;">
            EXCHANGE
        </h2>

        <div style="display:flex; justify-content:space-around; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">
            <div id="tabBuy" style="color:#00eaff; cursor:pointer; font-weight:bold; border-bottom:2px solid #00eaff; flex:1; text-align:center;">
                BUY COINS
            </div>
            <div id="tabSell" style="color:#666; cursor:pointer; flex:1; text-align:center; border-bottom:none;">
                SELL COINS
            </div>
        </div>

        <div id="panelBuy" style="display:block;">
            <p style="color:#aaa; font-size:0.8rem; text-align:center;">
                RATE: 1 WLD = ${BUY_RATE} COINS
            </p>
            <div style="background:rgba( 0,234,255,0.8);padding:15px; border-radius:8px; margin:10px 0;">
                <label style="color:#fff; display:block; margin-bottom:5px;">‡∏à‡πà‡∏≤‡∏¢ WLD</label>
                <input type="number" id="inpBuyWLD" value="${MIN_BUY_WLD}" step="0.1"
                       style="width:100%; background:#000; border:1px solid #444; color:#fff;
                              padding:10px; font-size:1.2rem; font-family:'Orbitron'; text-align:center;">
                <p style="color:#666; font-size:0.7rem; margin-top:5px; text-align:right;">
                    Min: ${MIN_BUY_WLD} WLD
                </p>
            </div>
            <div style="text-align:center; color:#fff; margin-bottom:15px;">
                ‚¨á ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ‚¨á <br>
                <span id="txtGetCoin" style="color:#ffd700; font-size:1.5rem; font-family:'Orbitron';">
                    ${Math.floor(MIN_BUY_WLD * BUY_RATE)}
                </span> COINS
            </div>
            <button id="btnConfirmBuy" class="main-btn"
                    style="width:100%; margin-top:10px; padding:12px; border-radius:8px; background:linear-gradient(135deg,#00eaff,#008cff); color:#000; font-weight:bold; border:none; cursor:pointer;">
                CONFIRM BUY
            </button>
        </div>

        <div id="panelSell" style="display:none;">
            <p style="color:#aaa; font-size:0.8rem; text-align:center;">
                RATE: ${SELL_RATE} COINS = 1 WLD
            </p>
            <div style="background:rgba(235,100,0,0.7); padding:15px; border-radius:8px; margin:10px 0;">
                <label style="color:#fff; display:block; margin-bottom:5px;">‡∏Ç‡∏≤‡∏¢ COINS</label>
                <input type="number" id="inpSellCoin" value="${MIN_SELL}" step="100"
                       style="width:100%; background:#000; border:1px solid #444; color:#fff;
                              padding:10px; font-size:1.2rem; font-family:'Orbitron'; text-align:center;">
                <p style="color:#666; font-size:0.7rem; margin-top:5px; text-align:right;">
                    Min: ${MIN_SELL} COINS
                </p>
            </div>
            <div style="text-align:center; color:#fff; margin-bottom:15px;">
                ‚¨á ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì) ‚¨á <br>
                <span id="txtGetWLD" style="color:#00eaff; font-size:1.5rem; font-family:'Orbitron';">
                    ${parseFloat((MIN_SELL / SELL_RATE).toFixed(4))}
                </span> WLD
            </div>
            <button id="btnConfirmSell" class="main-btn"
                    style="width:100%; background:#ff4444; border:none; padding:12px; border-radius:8px; color:white; font-weight:bold; cursor:pointer;">
                CONFIRM SELL
            </button>
        </div>
    `;

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    /* =====================================================
     * 4. VARIABLE BINDING & UI EVENTS
     * ===================================================== */
    const inpBuy = document.getElementById('inpBuyWLD');
    const txtGetCoin = document.getElementById('txtGetCoin');
    const inpSell = document.getElementById('inpSellCoin');
    const txtGetWLD = document.getElementById('txtGetWLD');

    document.getElementById('tabBuy').onclick = () => {
        document.getElementById('panelBuy').style.display = 'block';
        document.getElementById('panelSell').style.display = 'none';
        document.getElementById('tabBuy').style.color = '#00eaff';
        document.getElementById('tabBuy').style.borderBottom = '2px solid #00eaff';
        document.getElementById('tabSell').style.color = '#666';
        document.getElementById('tabSell').style.borderBottom = 'none';
    };

    document.getElementById('tabSell').onclick = () => {
        document.getElementById('panelBuy').style.display = 'none';
        document.getElementById('panelSell').style.display = 'block';
        document.getElementById('tabSell').style.color = '#00eaff';
        document.getElementById('tabSell').style.borderBottom = '2px solid #00eaff';
        document.getElementById('tabBuy').style.color = '#666';
        document.getElementById('tabBuy').style.borderBottom = 'none';
    };

    inpBuy.oninput = () => {
        let val = parseFloat(inpBuy.value) || 0;
        txtGetCoin.innerText = Math.floor(val * BUY_RATE);
    };

    inpSell.oninput = () => {
        let val = parseInt(inpSell.value) || 0;
        let rawWLD = val / SELL_RATE;
        txtGetWLD.innerText = parseFloat(rawWLD.toFixed(4)).toString();
    };

        /* =====================================================
     * 5. BUY LOGIC (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
     * ===================================================== */
    document.getElementById('btnConfirmBuy').onclick = async function () {
        if (this.disabled) return;
        const btn = this;

        let amountWLD = parseFloat(inpBuy.value) || 0;
        if (amountWLD < MIN_BUY_WLD)
            return gameAlert("ERROR", `‚õî ‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Ñ‡∏∑‡∏≠ ${MIN_BUY_WLD} WLD`);

        if (!window.MiniKit?.isInstalled())
            return gameAlert("ERROR", "‚õî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App");

        btn.disabled = true;
        btn.innerText = "PROCESSING PAY...";

        try {
            const coinsToReceive = Math.floor(amountWLD * BUY_RATE);
            const amountInWei = BigInt(Math.floor(amountWLD * 1000000)) * 1000000000000n;
            const refOrder = "order_" + Date.now();

            const result = await window.MiniKit.commandsAsync.pay({
                reference: refOrder,
                to: RECEIVER,
                tokens: [{
                    symbol: "WLD",
                    token_amount: amountInWei.toString()
                }],
                description: `Buy ${coinsToReceive} COINS`
            });

            if (result?.finalPayload?.status !== "success") {
                throw new Error("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å");
            }

            // üåü ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô World App ‡πÅ‡∏•‡πâ‡∏ß ‡∏¢‡∏¥‡∏á‡∏ö‡∏≠‡∏Å Server ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç
            btn.innerText = "SYNCING SERVER...";
            
            try {
                const syncRes = await fetch("https://game-server-vs0h.onrender.com/api/buy-coins", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        userId: window.REAL_USER_ID,
                        amountBought: coinsToReceive,
                        reference: refOrder
                    })
                });
                
                const syncData = await syncRes.json();
                
                if (syncData.success && syncData.newBalance !== undefined) {
                    playerCOIN = syncData.newBalance; // ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Server ‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                } else {
                    playerCOIN += coinsToReceive; // Fallback ‡∏ñ‡πâ‡∏≤‡∏¢‡∏¥‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö newBalance
                }
            } catch (syncErr) {
                console.warn("‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤ ‡πÅ‡∏ï‡πà‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß", syncErr);
                playerCOIN += coinsToReceive; // Fallback ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î‡∏ñ‡πâ‡∏≤ Server ‡∏•‡πà‡∏°‡∏ä‡∏±‡πà‡∏ß‡∏Ç‡∏ì‡∏∞
            }

            if (typeof updateBalance === "function") updateBalance();

            overlay.remove();
            
            // ‚úÖ ‡πÉ‡∏ä‡πâ gameAlert ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            gameAlert("PURCHASE SUCCESS", `‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <span style="color:#ffd700; font-size:1.2rem;">${coinsToReceive} COINS</span> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`);

        } catch (err) {
            console.error("Buy Error:", err);
            if (!err.message?.includes("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"))
                gameAlert("ERROR", "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (err.message || err));
        } finally {
            btn.disabled = false;
            btn.innerText = "CONFIRM BUY";
        }
    };


        /* =====================================================
     * 6. SELL LOGIC (‡∏ï‡∏±‡∏î‡πÄ‡∏•‡∏Ç‡∏™‡πÄ‡∏ï‡πá‡∏õ‡∏≠‡∏≠‡∏Å ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏Ñ‡πà WAIT...)
     * ===================================================== */
    document.getElementById('btnConfirmSell').onclick = async function () {

        const btn = this;
        if (btn.disabled) return;

        const amountCoin = parseInt(inpSell.value) || 0;

        if (amountCoin < MIN_SELL)
            return gameAlert("ERROR", `‚õî ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ${MIN_SELL} Coins`);

        if (typeof playerCOIN === "undefined" || playerCOIN < amountCoin)
            return gameAlert("ERROR", "‚õî Coin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏û‡∏≠!");

        if (!window.MiniKit?.isInstalled())
            return gameAlert("ERROR", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô World App");

        if (!window.REAL_USER_ID)
            return gameAlert("ERROR", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");

        btn.disabled = true;
        // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏à‡∏ô‡∏à‡∏ö‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£
        btn.innerText = "‚è≥ WAIT...";

        try {

            // Step 1: ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏´‡∏≤ server ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠ Signature
            const response = await fetch(WITHDRAW_API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId: window.REAL_USER_ID,
                    amount: amountCoin
                })
            });

            const data = await response.json();
            if (!data.success)
                throw new Error(data.message || "Server Rejected");

            // Step 2: ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á World App (‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô WAIT...)
            const txPayload = {
                transaction: [{
                    address: data.claimData.vaultAddress,
                    abi: [{
                        inputs: [
                            { internalType: "uint256", name: "amount", type: "uint256" },
                            { internalType: "uint256", name: "nonce", type: "uint256" },
                            { internalType: "bytes", name: "signature", type: "bytes" }
                        ],
                        name: "claimReward",
                        outputs: [],
                        stateMutability: "nonpayable",
                        type: "function"
                    }],
                    functionName: "claimReward",
                    args: [
                        data.claimData.amount,
                        data.claimData.nonce,
                        data.claimData.signature
                    ]
                }]
            };

            const txResult = await window.MiniKit.commandsAsync.sendTransaction(txPayload);

            if (txResult?.finalPayload?.status !== "success")
                throw new Error("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å");

            // Step 3: ‡πÇ‡∏≠‡∏ô‡∏ö‡∏ô Blockchain ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß -> ‡∏¢‡∏¥‡∏á‡∏ö‡∏≠‡∏Å Server (‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô WAIT...)
            const syncRes = await fetch("https://game-server-vs0h.onrender.com/api/withdraw-success", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId: window.REAL_USER_ID,
                    amount: amountCoin,
                    nonce: data.claimData.nonce 
                })
            });

            const syncData = await syncRes.json();

            if (syncData.success && syncData.newBalance !== undefined) {
                playerCOIN = syncData.newBalance;
            } else {
                playerCOIN -= amountCoin; 
            }

            if (typeof updateBalance === "function") updateBalance();

            overlay.remove();
            
            gameAlert("WITHDRAW SUCCESS", "‚úÖ ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br><span style='color:#00eaff; font-size:0.9rem;'>‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß</span>");

        } catch (e) {
            console.error("Sell Error:", e);
            if (!e.message?.includes("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"))
                gameAlert("ERROR", "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (e.message || "Unknown error"));
        } finally {
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ (‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å) ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô CONFIRM SELL
            btn.disabled = false;
            btn.innerText = "CONFIRM SELL";
        }
    };
    
}; // <--- ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏õ‡∏µ‡∏Å‡∏Å‡∏≤‡∏õ‡∏¥‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openExchangeModal ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
 

    </script>
</body>
</html>

  
